<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="Zh-cn">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/jessehao.github.io/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/jessehao.github.io/css/main.css?v=7.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/jessehao.github.io/images/apple-touch-icon-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/jessehao.github.io/images/favicon-32x32-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/jessehao.github.io/images/favicon-16x16-next.png?v=7.0.0">


  <link rel="mask-icon" href="/jessehao.github.io/images/logo.svg?v=7.0.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/jessehao.github.io/',
    scheme: 'Muse',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false,"dimmer":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="Zeriodical">
<meta property="og:url" content="https://github.com/jessehao/jessehao.github.io.git/index.html">
<meta property="og:site_name" content="Zeriodical">
<meta property="og:locale" content="Zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Zeriodical">






  <link rel="canonical" href="https://github.com/jessehao/jessehao.github.io.git/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Zeriodical</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="Zh-cn">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/jessehao.github.io/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zeriodical</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">埋头开荒，双商破冰，扬短避长，屎上醉男。</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/jessehao.github.io/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/jessehao.github.io/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/jessehao.github.io/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/jessehao.github.io/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/jessehao/jessehao.github.io.git/jessehao.github.io/2019/03/10/customize-UITableViewController-elegantly/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jesse Hao">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/jessehao.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zeriodical">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/jessehao.github.io/2019/03/10/customize-UITableViewController-elegantly/" class="post-title-link" itemprop="url">优雅地定制 UITableViewController</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-03-10 17:20:00 / Modified: 17:59:37" itemprop="dateCreated datePublished" datetime="2019-03-10T17:20:00+08:00">2019-03-10</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/jessehao.github.io/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/jessehao.github.io/categories/iOS/UI/" itemprop="url" rel="index"><span itemprop="name">UI</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>UITableViewController</code> 是专门设计用来应付<code>UITableView</code>的视图控制器，讲道理用它是比用普通的ViewController + Data Source &amp; Delegate 要方便很多的，它有很多便利的功能能加速我们开发TableViewController。</p>
<ul>
<li><p><strong><code>clearSelectionOnViewWillAppear</code></strong><br>若是在<code>UIViewController</code>上自己实现倒也是很简单。其实这个功能的名字几乎已经完全说明了他是怎么实现的。</p>
</li>
<li><p><strong>键盘监听与输入框防遮挡</strong><br>这个功能可以说是<code>UITableViewController</code>一大非常便利的功能。它提供了在列表视图中非常完美的输入框键盘防遮挡功能。只要你聚焦于其内部的某个输入框，他一定会以一种十分恰当的方式让聚焦框露出来。<br>但我们自己在<code>UIViewController</code>上实现的类似功能是有些费劲的。</p>
</li>
<li><p><strong>Refresh Control</strong><br>其内部的一个好处就是，在目前主流兼容的版本中，你不需要再做版本适配，因为它是从iOS 6起兼容的。而<code>UIScrollView</code>中的相同api是从iOS 10 起。如果你的项目是iOS 10以上起步的话，就忽略这个优点吧。</p>
</li>
</ul>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p><code>UITableViewController</code>的主控视图（<code>UIViewController.view</code>）是<code>UITableView</code>，而且他是继承了<code>UIScrollView</code>，所以当你直接往上面添加一个子视图（比如Toast、浮动按钮）的时候，你会发现这些子视图会跟着你页面一起上下滚动。<br>emmmm… 我当时在给公司项目接入toast的时候就是遇到了这个问题，所以我一怒之下抛弃了<code>UITableViewController</code></p>
<h4 id="UIViewController-Data-Source-amp-Delegate"><a href="#UIViewController-Data-Source-amp-Delegate" class="headerlink" title="UIViewController + Data Source &amp; Delegate"></a><code>UIViewController</code> + Data Source &amp; Delegate</h4><p>如果我们直接用<code>UIViewController</code>，并使<code>tableView</code>作为其<code>view</code>的子视图的话，toast的问题就可以解决，因为toast所坐落的父视图并不是一个滚动视图。<br>就酱，我以为从此我找到了究极解决方案，直到有一天在我写Terrace这个库的时候，一个<code>UITableViewCell</code>内置输入框键盘防遮挡的效果迟迟不能实现成我满意的样子。就在这个时候，我想起了曾经被我抛弃的<code>UITableViewController</code>处理起键盘防遮挡如丝顺滑。我决定再试一次<code>UITableViewController</code>。</p>
<h2 id="Customizing"><a href="#Customizing" class="headerlink" title="Customizing"></a>Customizing</h2><p>关键问题是要给<code>tableView</code>加个座垫儿。</p>
<h4 id="作为子控制器"><a href="#作为子控制器" class="headerlink" title="作为子控制器"></a>作为子控制器</h4><p>从iOS 5开始，苹果为<code>UIViewController</code>增加了子视图控制器概念，但类似的概念并不算苹果第一次提出，<code>UINavigationController</code>不就是导航栏爸爸管着一群视图控制器崽子们吗？</p>
<p><strong>UITableViewController 做为子控制器：</strong></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WrappedTableViewController</span> : <span class="title">UITableViewController</span> </span>&#123;</span><br><span class="line">	<span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewWillAppear</span><span class="params">(<span class="number">_</span> animated: Bool)</span></span> &#123;</span><br><span class="line">		<span class="keyword">super</span>.viewWillAppear(animated)</span><br><span class="line">        <span class="comment">// 被父控制器添加为子视图后配置约束</span></span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">let</span> superview = <span class="keyword">self</span>.parent?.view &#123;</span><br><span class="line">			<span class="keyword">self</span>.tableView.translatesAutoresizingMaskIntoConstraints = <span class="literal">false</span></span><br><span class="line">			<span class="keyword">self</span>.tableView.topAnchor.constraint(equalTo: superview.topAnchor).isActive = <span class="literal">true</span></span><br><span class="line">			<span class="keyword">self</span>.tableView.bottomAnchor.constraint(equalTo: superview.bottomAnchor).isActive = <span class="literal">true</span></span><br><span class="line">			<span class="keyword">self</span>.tableView.leftAnchor.constraint(equalTo: superview.leftAnchor).isActive = <span class="literal">true</span></span><br><span class="line">			<span class="keyword">self</span>.tableView.rightAnchor.constraint(equalTo: superview.rightAnchor).isActive = <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>UIViewController 父控制器：</strong></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewController</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> tableViewController = <span class="type">WrappedTableViewController</span>(style: .plain)</span><br><span class="line">	<span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">		<span class="keyword">self</span>.addChild(<span class="keyword">self</span>.tableViewController)</span><br><span class="line">		<span class="keyword">self</span>.view.addSubview(<span class="keyword">self</span>.tableViewController.tableView)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种方式可能会显得仅仅起包裹作用的父控制器没什么事做，当一个座垫儿是不是有点大材小用了。</p>
<h4 id="改变控制的tableView"><a href="#改变控制的tableView" class="headerlink" title="改变控制的tableView"></a>改变控制的<code>tableView</code></h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> tableView: <span class="type">UITableView!</span> &#123; <span class="keyword">get</span> <span class="keyword">set</span> &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Returns the table view managed by the controller object.</p>
</blockquote>
<p>既然它的目的是返回由控制器控制的<em>table view object</em>，我们可以通过<code>override</code>来达到我们的目的，告诉它谁才是真正的主角！</p>
<p>这次作为Container的就可以是一个UIView，而不是用UIViewController。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContainerView</span> : <span class="title">UIView</span> </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> tableView = <span class="type">UITableView</span>()</span><br><span class="line">    <span class="comment">// ... view configurations</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>敲黑板敲黑板！注意啦注意啦！</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TableViewController</span> : <span class="title">UITableViewController</span> </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> containerView = <span class="type">ContainerView</span>()</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 控制我们自己的TableView</span></span><br><span class="line">	<span class="keyword">override</span> <span class="keyword">var</span> tableView: <span class="type">UITableView!</span> &#123;</span><br><span class="line">		<span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.containerView.tableView &#125;</span><br><span class="line">		<span class="keyword">set</span> &#123;</span><br><span class="line">			<span class="keyword">self</span>.containerView.tableView = newValue</span><br><span class="line">			newValue.delegate = <span class="keyword">self</span></span><br><span class="line">			newValue.dataSource = <span class="keyword">self</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">loadView</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">self</span>.view = <span class="keyword">self</span>.containerView <span class="comment">// 将主视图替换为自定义基底视图</span></span><br><span class="line">		<span class="keyword">self</span>.tableView.delegate = <span class="keyword">self</span></span><br><span class="line">		<span class="keyword">self</span>.tableView.dataSource = <span class="keyword">self</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先在<code>loadView</code>配置本控制器显示的主视图不再是默认的<code>tableView</code>，而是我们准备的<code>containerView</code>。然后让<code>tableView</code>的<code>getter</code>和<code>setter</code>都指向我们自己的<code>tableView</code>，<strong>别忘了指定<code>dataSource</code>和<code>delegate</code></strong>。</p>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>当时我在<code>tableView</code>上解决toast问题和输入框键盘遮挡问题，第一次使用UITableViewController的时候也是我第一次用UITableView的时候。当时还并没有深入了解视图控制器对视图的加载时机和自定义方式，直到后来学会了利用<code>loadView</code>方法。但那个时候我已经在<code>UIViewController</code> + DataSource &amp; Delegate 的方式中走了很久，再直到后来一次在这个方式基础之上处理输入框键盘遮挡问题时觉得很麻烦，才在一次将注意力移回到UITableViewController上。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/jessehao/jessehao.github.io.git/jessehao.github.io/2017/07/18/beginning-of-objc-memory-management/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jesse Hao">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/jessehao.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zeriodical">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/jessehao.github.io/2017/07/18/beginning-of-objc-memory-management/" class="post-title-link" itemprop="url">Objective-C的内存管理艺术：入门</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-07-18 23:43:00" itemprop="dateCreated datePublished" datetime="2017-07-18T23:43:00+08:00">2017-07-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-03-01 14:03:45" itemprop="dateModified" datetime="2019-03-01T14:03:45+08:00">2019-03-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/jessehao.github.io/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://upload-images.jianshu.io/upload_images/1704151-2b4e62102744ddcc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="文章框架"></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p> 呀！！再也不三心二意了，从今往后专心搞iOS！嗯！<br>从大一开始就嚷嚷对iOS热爱的很，结果呢，就毕设写了个垃圾，咦！<br>所以现在起，iOS就是我的主线了！先写这篇垃圾文章壮壮气势！</p>
<p>本篇内容非常浅显的谈谈Objective-C中的内存管理，适合那些会写点简单的App但从未认真对待过内存管理的初级iOS工程师阅读，在整个内存管理的艺术之路上入个门。</p>
<hr>
<h2 id="传统内存管理"><a href="#传统内存管理" class="headerlink" title="传统内存管理"></a>传统内存管理</h2><p>传统的内存管理我想从C语言说起。当你用<code>malloc</code>函数申请一片空间的时候（或是C++的<code>new</code>），就一定要用<code>free</code>函数释放掉（或是C++的<code>delete</code>）。</p>
<p>但是在面向对象的世界，我们一切打交道的东西是<strong>对象</strong>，这玩意你可不能说来就来说走就走，来就得初始化一下（<strong>构造函数</strong>，空间申请+变量初始化），走就得垂死挣扎一下（<strong>析构函数</strong>，遗产管理+空间释放）。</p>
<p>Objective-C是一门面向对象的语言，所以其与之对应的方法就是<code>alloc</code>、<code>init</code>和<code>dealloc</code>。<code>dealloc</code>就是析构函数。其构造函数相当于先调用<code>alloc</code>再<code>init</code>，说白了就是他把空间申请和变量初始化分的很清楚，<code>alloc</code>就是空间申请，<code>init</code>就是变量初始化，这俩通常是成对儿出现的。你问只<code>alloc</code>不<code>init</code>行不行，可以！没问题！只不过你的私有成员表示很郁闷：谁来给我们赋初值啊？</p>
<h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><ul>
<li><strong>构造函数</strong><br>也就是构造的时候，在objective-c中定义构造函数时不用你去申请空间，只是写好初始化方法<code>init</code>就好了</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (instanceType) init &#123;</span><br><span class="line">  [<span class="keyword">super</span> init];  <span class="comment">// 别忘了要把祖宗也都构造上</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">self</span>)&#123;</span><br><span class="line">    <span class="comment">// 需要初始化的东西</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>析构函数</strong><br>析构函数，在对象被释放之前，对象总要那么挣扎几下才会安心的去的。不过你也可以让你的对象没有任何想说的直接挂掉，这就可能会出现问题：这财产归谁啊？还是彻底不要了？不能扔那不管啊！ </li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>) dealloc &#123;</span><br><span class="line">  <span class="comment">// 遗嘱</span></span><br><span class="line">  [<span class="keyword">super</span> dealloc];  <span class="comment">// 株连九族</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意，这里超类的析构函数要最后调用。</p>
<h4 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h4><ul>
<li><strong>构造函数</strong></li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ClassName* instance = [[ClassName alloc] init]; <span class="comment">// 先构造再初始化</span></span><br></pre></td></tr></table></figure>
<p>如果说你的构造函数不需要什么参数，直接走默认</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ClassName* instance = [ClassName new]; <span class="comment">//  等价于上面的</span></span><br></pre></td></tr></table></figure>
<p>如果你很奔放的不需要初始化</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ClassName* instance = [ClassName alloc]; <span class="comment">// 完全没问题！ 没毛病~</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>析构函数</strong></li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[instance dealloc];</span><br></pre></td></tr></table></figure>
<p>至此，在Objective-C中最基本的动态内存管理算是介绍完了。你要是不看后面的直接这么玩，没问题！</p>
<p>那么问题来了：遇到复杂的情况，这种传统模式就很捉急。<br>比如我要在<code>指针A</code>中引用<code>空间M</code>，<code>引用B</code>也要引用<code>对象M</code>，<code>对象C</code>也来凑热闹引用了<code>对象M</code>。哇！这对象M简直是香饽饽。<code>A</code>说了：“这盘香饽饽是我做的，我要吃，谁最后吃完谁收拾剩饭”；<code>B</code>说了：“这盘香饽饽我要吃，谁最后吃完谁收拾剩饭”；<code>C</code>说：“我不吃，我就看看。”</p>
<p>好，最后这盘香饽饽什么时候收拾？对应在程序里面也就是什么时候调用<code>[M dealloc]</code>？</p>
<p>谁最后吃完谁收拾呗，说得好听！谁知道程序里面谁最后吃完啊，对应着用上面的方式<code>A</code> <code>B</code> <code>C</code>里面都引用了<code>M</code>，<code>A</code>和<code>B</code>谁最后吃完那完全是看心情的，都任性的很呢！</p>
<hr>
<h2 id="引用计数管理"><a href="#引用计数管理" class="headerlink" title="引用计数管理"></a>引用计数管理</h2><p>引用计数是个好方法，能解决上面的香饽饽问题。也就是这种机制可以让程序知道到底是谁最后吃完了香饽饽。<br>其基本思想：用一个计数器，来一个吃香饽饽的就<code>+1</code>，吃完一个就<code>-1</code>，减到0了就释放。</p>
<h4 id="手动引用计数（MRC-Manual-Reference-Counting）"><a href="#手动引用计数（MRC-Manual-Reference-Counting）" class="headerlink" title="手动引用计数（MRC, Manual Reference Counting）"></a>手动引用计数（MRC, Manual Reference Counting）</h4><p>或称为MRR（Manual Retain Release）。这算是最基本的引用计数操作。</p>
<ul>
<li><strong><code>+1</code></strong><br>对应的方法就是<code>retain</code>。但除此之外，由<code>alloc</code>、<code>new</code>、<code>copy</code>、<code>mutableCopy</code>这样直接生成对象的方法会直接让引用计数自动+1，加给谁？就是<code>=</code>左边的那位。<br>所以像前面的这种<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ClassName* instance = [[ClassName alloc] init];</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>instance所指向的对象引用计数会直接+1。<br>你说我没有左边那位是不是也要+1呀？是！<br>如果你直接这样写：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[ClassName alloc] init]</span><br></pre></td></tr></table></figure></p>
<p>等你去编译的时候，编译器就给你改成<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">id</span> tmp = [[ClassName alloc] init]</span><br><span class="line">[tmp autorelease]</span><br></pre></td></tr></table></figure></p>
<p>是的，他就偏往<code>=</code>左边临时放一位，<code>id</code>相当于C语言中的<code>void *</code>指针，这里不谈。<code>autorelease</code>方法本篇也不谈，你可以暂时把它看成<code>release</code>也就是我下面<strong><code>-1</code></strong>部分要说的。<br>就像前面的香饽饽情形中，香饽饽M是A做的，A和B都要吃，C只看不吃：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ClassName* pointerA = [[ClassName alloc] init];  <span class="comment">// 引用计数+1</span></span><br><span class="line">ClassName* pointerB = [pointerA <span class="keyword">retain</span>];  <span class="comment">// 引用计数+1</span></span><br><span class="line">ClassName* pointerC = pointerA;  <span class="comment">// 引用计数不改变，C：我就静静的看着你们吃</span></span><br></pre></td></tr></table></figure></p>
<p>引用计数为2，也就是有两位正在享用香饽饽。</p>
<ul>
<li><strong><code>-1</code></strong><br>吃完了，就别直接收拾了，得看看其他人还有没有吃完是我们中华民族的传统美德，为了经这种美德延续下去，你调用个<code>release</code>就行啦（但别忘了，赋nil）。<br>A吃完了：<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[instanceA release];  <span class="comment">// 引用计数-1</span></span><br><span class="line">instanceA = <span class="literal">nil</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>B吃完了：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[instanceB release];  <span class="comment">// 引用计数-1</span></span><br><span class="line">instance = <span class="literal">nil</span>;</span><br></pre></td></tr></table></figure></p>
<p>当引用计数减为0时，就释放空间，也就是收拾剩饭。<br>为什么要后面赋nil：因为release之后，指针还是指向那片空间，如果等那个空间被释放了，一不小心又通过那个指针（这时这个指针有了一个响当当的名字：悬垂指针，详见注释2）访问了一下那片空间，那就很危险了。如果那片被回收的区域没有被其他程序覆写，那还好，你可能还侥幸能访问到那里的东西。但如果那片空间被其他人覆写了，这就是非法访问了，非法访问的后果就是crash!<br>C说了：我要搞事情！<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[instanceC release];</span><br><span class="line">instanceC = <span class="literal">nil</span>;  <span class="comment">// 搞完事就跑路真刺激！</span></span><br></pre></td></tr></table></figure></p>
<p>行不行？还真可以！无论是编译阶段还是运行时他都不会报错的。这就等于C在饭局中冒充一个用餐的喊了句：我吃完啦！最后计数器一算：噢，客人都吃完走了，可以收拾饭桌了。结果最后真正还在吃的那位：MMP!<br>程序中是这样的:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[instanceA release];  <span class="comment">// 引用计数-1</span></span><br><span class="line">instanceA = <span class="literal">nil</span>;</span><br><span class="line">[instanceC release];  <span class="comment">// 引用计数-1，此时引用计数已经为0了，自动调用dealloc</span></span><br><span class="line">instanceB = <span class="literal">nil</span>;</span><br><span class="line">[instanceB release];  <span class="comment">// 很有可能还没执行到这一步程序已经崩溃了，因为B先生开始发疯：我的饭呢？！</span></span><br><span class="line">instanceC = <span class="literal">nil</span>;</span><br></pre></td></tr></table></figure></p>
<p>就算B先生恰好也吃完了，在他说“我吃完了”的时候，发现没人鸟他了，这时B先生又疯了！所以程序又崩了。<br>这个疯了在程序里指的就是B先生变成了悬垂指针。</p>
<p>另外，如果你想查看引用计数就调用<code>[instance retainCount]</code>，它会返回一个无符号整形，也就是引用计数的值。<br>你会发现当减到0的时候，如果你再调用<code>retainCount</code>的话，其值仍然为1，首先你这样做是非常危险的，因为他已经被释放了，你现在是在访问悬垂指针。如果能访问到值而没有崩溃当然是因为那块被回收的空间还没有被覆写，其次它的计数值没有变为0是因为没有必要了，这块空间已经被释放了，也没必要去给它计算多一次，而且这个1本是你不该知道的！</p>
<p>至此，你可以发现MRC还是很屌的，只要你别犯贱，一般不会出现什么问题了，也完美解决了之前的香饽饽问题。</p>
<h4 id="自动引用计数（ARC-Automatic-Reference-Counting）"><a href="#自动引用计数（ARC-Automatic-Reference-Counting）" class="headerlink" title="自动引用计数（ARC, Automatic Reference Counting）"></a>自动引用计数（ARC, Automatic Reference Counting）</h4><p>自动引用计数的出现减少了很多的内存管理代码，从而交给编译器自动去做。是的，这玩意儿是编译器层面的（但不完全是，也需要运行时的帮助，但认识它，透过它编译时所做的事就够了）。</p>
<h5 id="所有权修饰符"><a href="#所有权修饰符" class="headerlink" title="所有权修饰符"></a>所有权修饰符</h5><ul>
<li><strong><code>__strong</code></strong><br>强修饰符，默认修饰。修饰对象属性的时候写成<code>@property(strong)</code><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">id</span> creator = [[<span class="built_in">NSObject</span> alloc] init];  <span class="comment">// 这个也是__strong修饰的，默认修饰</span></span><br><span class="line">    <span class="keyword">id</span> __<span class="keyword">strong</span> strongRef = creator;</span><br><span class="line">    <span class="comment">// something else</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>相当于MRC中的<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">id</span> creator = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line">    <span class="keyword">id</span> strongRef = [creator <span class="keyword">retain</span>];</span><br><span class="line">    <span class="comment">// something else</span></span><br><span class="line">    [strongRef release];</span><br><span class="line">    [creator release];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>意思就是，只要是给我strong引用赋值的，我都会retain那个对象。<br>而且那个<code>__strong</code>可以不写出来，因为它是在ARC下默认的所有权修饰符。<br>而且在这个修饰的变量在其生命周期结束后，会自动调用release。并不是动态的调用<code>release</code>，而是ARC会帮你在那个生命周期结束的位置自动写上<code>release</code>。</p>
<ul>
<li><strong><code>__weak</code></strong><br>弱修饰符，修饰对象属性的时候写成<code>@property(weak)</code>。带有此修饰符的指针变量所指向的对象被释放后自动赋<code>nil</code>。本修饰符在iOS4以上支持，若是之前的版本就用<code>__unsafe_unretain</code>修饰符代替（对应的属性修饰为<code>@property(assign)</code>）。但是它不会自动赋<code>nil</code>，所以它是不安全的。<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">id</span> creator = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line">    <span class="keyword">id</span> __<span class="keyword">weak</span> weakRef = creator;</span><br><span class="line">    <span class="comment">// something else</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>相当于MRC中的<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">id</span> creator = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line">    <span class="keyword">id</span> weakRef = creator;</span><br><span class="line">    <span class="comment">// something else</span></span><br><span class="line">    weakRef = <span class="literal">nil</span>;  <span class="comment">// 若引用所指向的对象的引用计数为0后就自动赋nil</span></span><br><span class="line">    [creator release];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>总的来说就是ARC帮你在编译时写了MRC要写的东西，MRC中的那些方法在ARC是不支持的（<code>retain</code>、<code>release</code>、<code>autorelease</code>、<code>dealloc</code>、<code>retainCount</code>不可以人为调用，因为ARC已经帮你写好了）。所以并不是说有了ARC就完全不用担心内存管理，有些需要在运行时管理的内存还是不能太依赖ARC。它只是帮你从那些一般的MRC操作中释放出来。</p>
<hr>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>可以发现从传统到MRC再到ARC是一层一层进化而来，在传统上添加一个引用计数器就是MRC，编译器接手引用计数就变成了ARC。<br>除此之外上述之外，还有autoreleasepool，本文不提。有兴趣的朋友自行翻资料吧，这篇文章只是在Objective-C内存管理方面带你入个门。</p>
<hr>
<h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><ol>
<li>野指针(Wild Pointer)：在声明指针变量时，有些开发语言并不会帮你自动赋nil。所以这个指针可能在刚声明的时候是指向一个迷の区域的。这样的指针就是野指针。</li>
<li>悬垂指针(Dangling Pointer)：悬垂指针就是本指向一个曾经有对象（该指针曾经指向的对象）的空间，但现在是被回收的空间。</li>
<li>内存泄漏(Memory Leak)：内存泄漏指的是内存中存在一些对象实体，他们占用空间，却没有任何指针变量指向他们，所以他们不会被释放掉。</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/jessehao/jessehao.github.io.git/jessehao.github.io/2017/06/07/vscode-cpp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jesse Hao">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/jessehao.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zeriodical">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/jessehao.github.io/2017/06/07/vscode-cpp/" class="post-title-link" itemprop="url">LOX: 利用VSCode进行C/C++开发</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-06-07 15:05:00" itemprop="dateCreated datePublished" datetime="2017-06-07T15:05:00+08:00">2017-06-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-03-01 14:52:29" itemprop="dateModified" datetime="2019-03-01T14:52:29+08:00">2019-03-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/jessehao.github.io/categories/LOX/" itemprop="url" rel="index"><span itemprop="name">LOX</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="文章框架"><a href="#文章框架" class="headerlink" title="文章框架"></a>文章框架</h1><p><img src="http://upload-images.jianshu.io/upload_images/1704151-edc2731887b2158f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="脑图"></p>
<hr>
<hr>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><strong>LOX</strong>(Lightweight Open-source Xplatform)是我正在编写的一个全新文集，意思就如其名：<strong>轻量级-开源-跨平台</strong>。就是这个系列中的文章和例程都符合轻量级(Lightweight)、开源(Open-Source)、跨平台(Cross-Platform)。嗯，我这人吧，就好起一些新的名词。<br>本篇作为LOX系列的第一篇，也向你展示了一个最简单的LOX项目。如果想看一个稍微复杂一点的LOX项目，可以clone我Github上的一个Repo：<a href="https://github.com/jessehao/2048_CLI_xplat_cpp_cmake">2048 CLI</a>。欢迎来搞~</p>
<hr>
<h1 id="单源文件"><a href="#单源文件" class="headerlink" title="单源文件"></a>单源文件</h1><p>先从简单的来，一个源文件。</p>
<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><p>进行本次LOX开发所需要工具，点击下面的Title进入官网下载。</p>
<ul>
<li><h4 id="VSCode-Visual-Studio-Code"><a href="#VSCode-Visual-Studio-Code" class="headerlink" title="VSCode (Visual Studio Code)"></a><a href="https://code.visualstudio.com/" target="_blank" rel="noopener">VSCode (Visual Studio Code)</a></h4>VSCode是微软出品的一款非常良心的轻量级编辑器，虽说是完全照着Sublime Text弄出来的，但它<strong>免费</strong>啊，还开源啊，所以我也就不深究模仿不模仿了。（嗨呀，原则呢？嗯？）</li>
</ul>
<p><strong>需要的插件</strong> </p>
<table>
<thead>
<tr>
<th style="text-align:center">插件</th>
<th style="text-align:center">标识符</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.cpptools" target="_blank" rel="noopener">C/C++</a></td>
<td style="text-align:center">ms-vscode.cpptools</td>
<td style="text-align:left">C/C++语言支持，简单的编辑、编译、调试等功能。</td>
</tr>
</tbody>
</table>
<ul>
<li><h4 id="MinGW-Minimalist-GNU-for-Windows"><a href="#MinGW-Minimalist-GNU-for-Windows" class="headerlink" title="MinGW (Minimalist GNU for Windows)"></a><a href="http://www.mingw.org/" target="_blank" rel="noopener">MinGW (Minimalist GNU for Windows)</a></h4>这个工具是在Windows上需要的。因为Windows没有GNU工具包，MinGW就是为Windows而生的GNU工具包。</li>
</ul>
<p><strong>需要安装的包</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">包</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">mingw32-gcc.bin</td>
<td style="text-align:center">GNU C编译器</td>
</tr>
<tr>
<td style="text-align:center">mingw32-gcc-g++.bin</td>
<td style="text-align:center">GNU C++编译器</td>
</tr>
<tr>
<td style="text-align:center">mingw32-gdb.bin</td>
<td style="text-align:center">GNU 调试器</td>
</tr>
</tbody>
</table>
<p><strong>环境变量</strong><br>在系统变量的<code>PATH</code>中，添加MinGW安装的根目录中的bin文件夹（如<code>C:\MinGW\bin</code>），且尽量将这一项往上移（为了优先搜索该目录）。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1704151-08487af4f6567b0c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="设置过程"><br>完成这一步后，如果打开了VSCode，记得要重启VSCode。</p>
<hr>
<h2 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h2><p>  <strong>建立工作空间</strong> </p>
<p>  新建一个文件夹 - 右键 - <strong>Open with Code</strong>。使用这种方法的前提是你在安装VSCode时选中了“”<br><img src="http://upload-images.jianshu.io/upload_images/1704151-515e240cf993e520.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Open with Code"><br>或者在VSCode中 - 文件 - <strong>打开文件夹</strong>，选中一个空文件夹作工作空间。</p>
<p>  <strong>新建源文件</strong><br>  鼠标移动到新建的文件夹的根目录处（我的是“HelloWorld”），点击下图蓝色框住的图标（新建文件）。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-d457c1be4168dd0f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="新建按钮"><br>之后在其中输入文件名（包括后缀名），本例的后缀名写”.c”或”.cpp”。然后在其中写个最简单的HelloWorld。</p>
<p>  <strong>代码</strong><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Hello World"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>编码时，如果想自动补全，需要在包含指定头文件后保存代码，然后才会启动自动补全。<br>也就是说，它只对保存后的代码进行探测。</p>
<hr>
<h2 id="生成"><a href="#生成" class="headerlink" title="生成"></a>生成</h2><p>生成快捷键：<code>Ctrl(Mac: Command)+Shift+B</code><br>第一次生成时，VSCode会提示找不到生成的配置文件<code>task.json</code>，点击“配置生成任务”。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-5a733972369a1f05.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="配置生成任务"><br>在给出的模板中选择<code>Others</code>。在打开的<code>task.json</code>中改为下述代码。<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"0.1.0"</span>,</span><br><span class="line">    <span class="attr">"command"</span>: <span class="string">"gcc"</span>,</span><br><span class="line">    "isShellCommand": true,    // 是否为Shell命令</span><br><span class="line">    "args": ["-g","$&#123;file&#125;","-o","$&#123;fileDirname&#125;/$&#123;fileBasenameNoExtension&#125;.out"],</span><br><span class="line">    "showOutput": "always"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其实作用就是代码中所述的。<br><code>&quot;command&quot;: &quot;gcc&quot;</code>和<code>&quot;args&quot;: [&quot;-g&quot;,&quot;${file}&quot;,&quot;-o&quot;,&quot;${fileDirname}/${fileBasenameNoExtension}.out&quot;]</code>就相当于在<a href="https://en.wikipedia.org/wiki/Shell_(computing" target="_blank" rel="noopener">Shell</a>)中直接键入<code>gcc -c 源文件.c -o 源文件所在目录/源文件.out</code>。将鼠标放在Key（冒号前面的）上会显示所对应的意思（下面的Launch.json同）。<br>简单的解释一下其中几个<code>$</code>标识</p>
<table>
<thead>
<tr>
<th style="text-align:center">标识</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>${file}</code></td>
<td style="text-align:left">当前文件的完整文件名（包括路径、文件名、后缀名）</td>
</tr>
<tr>
<td style="text-align:center"><code>${fileDirname}</code></td>
<td style="text-align:left">当前文件的路径</td>
</tr>
<tr>
<td style="text-align:center"><code>${fileBasenameNoExtension}</code></td>
<td style="text-align:left">当前文件的文件名（<strong>不</strong>包括路径、后缀名）</td>
</tr>
</tbody>
</table>
<p>其中所说的“当前文件”指的是你在VSCode编辑器中打开的并正在编辑的文件。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-60eef620dc93c3c6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="当前正在编辑的文件"></p>
<p>完成<code>task.json</code>的配置后，我们缩写的程序已经可以运行了。生成的程序就是源文件所在根目录中出现的与源文件同名但后缀名为<code>.out</code>的文件。</p>
<hr>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>我们当然不能仅仅满足于生成出程序就行的，大部分情况我们是要调试的。</p>
<h5 id="调试快捷键：F5"><a href="#调试快捷键：F5" class="headerlink" title="调试快捷键：F5"></a>调试快捷键：<code>F5</code></h5><p>第一次按<code>F5</code>时和生成时一样，找不到配置文件，在打开的模板中选<code>C++ (GDB/LLDB)</code>（可以跨平台）。<br>生成的配置文件为<code>launch.json</code></p>
<h5 id="将launch-json改为下述代码"><a href="#将launch-json改为下述代码" class="headerlink" title="将launch.json改为下述代码"></a>将<code>launch.json</code>改为下述代码</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"0.2.0"</span>,</span><br><span class="line">    <span class="attr">"configurations"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            "name": "(gdb) Launch",    // 本配置的名称，随便起</span><br><span class="line">            "type": "cppdbg",</span><br><span class="line">            "request": "launch",    // 如果调试的类型为附加进程，需将这里改为attach</span><br><span class="line">            "program": "$&#123;fileDirname&#125;/$&#123;fileBasenameNoExtension&#125;.out",    // 要调试的程序路径</span><br><span class="line">            "stopAtEntry": false,    // 是否在起点处停顿</span><br><span class="line">            "cwd": "$&#123;workspaceRoot&#125;",</span><br><span class="line">            "externalConsole": true,    // 在外部控制台运行。若为false，则运行在VSCode自带的控制台中</span><br><span class="line">            "linux": &#123;    // Linux 系统下的配置</span><br><span class="line">                "MIMode": "gdb"</span><br><span class="line">            &#125;,</span><br><span class="line">            "osx": &#123;    // OS X系统下的配置</span><br><span class="line">                "MIMode": "lldb"</span><br><span class="line">            &#125;,</span><br><span class="line">            "windows": &#123;    // Windows 系统下的配置</span><br><span class="line">                "MIMode": "gdb",</span><br><span class="line">                "miDebuggerPath": "gdb.exe"</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Windows默认是没有gdb或lldb的，所以我们需要安装MinGW中的gdb，并在这里设置gdb的路径。只写程序名是因为设置了环境变量。<br>完成<code>launch.json</code>的配置并切换到源代码编辑页之后</p>
<h5 id="再一次：F5"><a href="#再一次：F5" class="headerlink" title="再一次：F5"></a>再一次：<code>F5</code></h5><p><img src="http://upload-images.jianshu.io/upload_images/1704151-2441f7ae3001340a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="打上断点"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1704151-aa1d652013107180.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="合影留念"></p>
<hr>
<hr>
<h1 id="多源文件"><a href="#多源文件" class="headerlink" title="多源文件"></a>多源文件</h1><p>什么！你不满足于单源文件开发？！来来来，我给你看个宝贝。</p>
<p>的确，单源文件开发一般也就是个做做算法题，现在随便写个像样的工程都是多个源文件编译链接一条龙的。这样VSCode可以吗，也可以！但需要新的帮手：<strong>CMake</strong>。</p>
<h2 id="工具-1"><a href="#工具-1" class="headerlink" title="工具"></a>工具</h2><ul>
<li><h4 id="VSCode-Visual-Studio-Code-1"><a href="#VSCode-Visual-Studio-Code-1" class="headerlink" title="VSCode (Visual Studio Code)"></a><a href="https://code.visualstudio.com/" target="_blank" rel="noopener">VSCode (Visual Studio Code)</a></h4></li>
</ul>
<p><strong>新需要的插件</strong><br>实际上通过CMake在VSCode上进行项目开发可以不需要任何插件，但是用上这些插件之后你会发现这个过程会变得特别方便！<br>除去单源文件中所提到的<code>cpptools</code>，还需要下面的插件。</p>
<table>
<thead>
<tr>
<th style="text-align:center">插件</th>
<th style="text-align:center">标识符</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://marketplace.visualstudio.com/items?itemName=twxs.cmake" target="_blank" rel="noopener">CMake</a></td>
<td style="text-align:center">twxs.cmake</td>
<td style="text-align:left">提供CMake语法支持，包括高亮和自动补全等</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://marketplace.visualstudio.com/items?itemName=vector-of-bool.cmake-tools" target="_blank" rel="noopener">CMake Tools</a></td>
<td style="text-align:center">vector-of-bool.cmake-tools</td>
<td style="text-align:left">这个屌！完全把CMake封装成一套VSCode底边栏的工具集</td>
</tr>
</tbody>
</table>
<ul>
<li><h4 id="MinGW-Minimalist-GNU-for-Windows-1"><a href="#MinGW-Minimalist-GNU-for-Windows-1" class="headerlink" title="MinGW (Minimalist GNU for Windows)"></a><a href="http://www.mingw.org/" target="_blank" rel="noopener">MinGW (Minimalist GNU for Windows)</a></h4>同样这一步仅在Windows上做。</li>
</ul>
<p><strong>需要新安装的包</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">包</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">mingw32-make.bin</td>
<td style="text-align:center">GNU Make，根据makefiles（在这里makefiles由CMake搞定）生成项目</td>
</tr>
</tbody>
</table>
<p>为了方便调用，我一般会把<code>mingw32-make.exe</code>在其目录中复制一份出来，命名为<code>make.exe</code>。<br>这一步某种程度意义上讲还蛮重要的，第一是方便自己调用（直接在shell里<code>make</code>），第二是方便vscode的插件调用（如果不弄一个<code>cmake.exe</code>出来的话，<code>vector-of-bool.cmake-tools</code>会报错，不过具体锅是<a href="https://github.com/vector-of-bool/vscode-cmake-tools"><code>vector-of-bool.cmake-tools</code></a>还是<a href="https://github.com/twxs/vs.language.cmake"><code>twxs.cmake</code></a>的也不太清楚，目前<a href="https://github.com/vector-of-bool">vector-of-bool</a>已经把这个问题(<a href="https://github.com/vector-of-bool/vscode-cmake-tools/issues/157"><code>#157</code></a>)标记为<code>bug</code>，并打算在<a href="https://github.com/vector-of-bool/vscode-cmake-tools/releases"><code>0.10.0</code></a>版本解决。）。</p>
<ul>
<li><h4 id="CMake"><a href="#CMake" class="headerlink" title="CMake"></a><a href="https://cmake.org/" target="_blank" rel="noopener">CMake</a></h4>安装时记得将<code>Add CMake to system PATH</code>勾上。是<code>for all users</code>呢还是<code>for current user</code>你自己看咯。</li>
</ul>
<hr>
<h2 id="编码-1"><a href="#编码-1" class="headerlink" title="编码"></a>编码</h2><p>上个例子是C，那这个就上C++好了。</p>
<h4 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h4><p>我就不同目录下多文件了啊，那没啥意思。咱上多层级目录多源文件的。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-519752f3f49b83ce.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="目录结构"></p>
<h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><ul>
<li><code>Printer.h</code></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Printer</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;</span><br><span class="line">    Printer();</span><br><span class="line">    ~Printer();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>Printer.cpp</code></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Printer.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">void</span> Printer::print()&#123;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"Hello World"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Printer::Printer() &#123;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="string">"Printer Object Constructed"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> Printer::~Printer()&#123;</span><br><span class="line">     <span class="built_in">cout</span>&lt;&lt;<span class="string">"Printer Object Destructed"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>‘main.cpp’</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Lib/Printer.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Printer* printer = <span class="keyword">new</span> Printer();</span><br><span class="line">    printer-&gt;print();</span><br><span class="line">    <span class="keyword">delete</span> printer;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="生成项目"><a href="#生成项目" class="headerlink" title="生成项目"></a>生成项目</h2><h4 id="编写CMakeLists"><a href="#编写CMakeLists" class="headerlink" title="编写CMakeLists"></a>编写CMakeLists</h4><p>每一个包含源文件的目录中都要编写<code>CMakeLists.txt</code></p>
<ul>
<li><code>CMakeLists.txt</code><br>根目录中的<code>CMakeLists.txt</code>，一般程序入口（<code>main</code>函数）在此。</li>
</ul>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用CMake Tools插件（可选，如果这个项目去到一个没有这个插件的机器也同样可以生成项目）</span></span><br><span class="line"><span class="keyword">include</span>(CMakeToolsHelpers OPTIONAL)</span><br><span class="line"></span><br><span class="line"><span class="comment"># CMake 最低版本号要求</span></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">2.8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 项目名称</span></span><br><span class="line"><span class="keyword">project</span>(CMakeTest)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找当前目录下的所有源文件</span></span><br><span class="line"><span class="comment"># 并将名称保存到 DIR_ROOT_SRCS变量</span></span><br><span class="line"><span class="keyword">aux_source_directory</span>(. DIR_ROOT_SRCS)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加 Lib子目录</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(Lib)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定生成目标</span></span><br><span class="line"><span class="keyword">add_executable</span>(CMakeTest main.cpp <span class="variable">$&#123;DIR_ROOT_SRCS&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加链接库</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(CMakeTest PrinterLib)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>Lib/CMakeLists.txt</code><br>子目录中的<code>CMakeLists.txt</code>，一般将子目录中的源文件编译为静态链接库。</li>
</ul>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(CMakeToolsHelpers OPTIONAL)</span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">2.8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">aux_source_directory</span>(. DIR_LIB_SRCS)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成链接库</span></span><br><span class="line"><span class="keyword">add_library</span>(PrinterLib <span class="variable">$&#123;DIR_LIB_SRCS&#125;</span>)</span><br></pre></td></tr></table></figure>
<h4 id="Build"><a href="#Build" class="headerlink" title="Build"></a>Build</h4><p>完成上面步骤后，就可以Build了，如果你安装了<code>vector-of-bool.cmake-tools</code>插件，VSCode左下角的底边栏会有<code>Build</code>按钮。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-78bbca7990218cf1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Build Button"><br>点击<code>Build</code>后，选择<code>Debug</code>（为了下一步演示调试，若不调试就<code>Release</code>）<br><img src="http://upload-images.jianshu.io/upload_images/1704151-456e425563fa52c8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Build Setting"><br>输出框会不停往出喷东西，只要最后输出了<code>[vscode] cmake exited with return code 0</code>，就说明Build成功。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-02fb690e548d4848.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Build Output"></p>
<h4 id="目录结构-1"><a href="#目录结构-1" class="headerlink" title="目录结构"></a>目录结构</h4><p><img src="http://upload-images.jianshu.io/upload_images/1704151-5c039eb579a932b6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="目录结构"><br>新增加的build文件夹是<code>vector-of-bool.cmake-tools</code>插件干的，它做的很好，如果我们手动<code>cmake - make</code>，那些生成文件会跑的到处都是。<br>其中<code>build/CMakeTests.exe</code>就是我们生成的可执行程序。</p>
<hr>
<h2 id="调试-1"><a href="#调试-1" class="headerlink" title="调试"></a>调试</h2><h4 id="调试设置"><a href="#调试设置" class="headerlink" title="调试设置"></a>调试设置</h4><p><code>文件</code> - <code>首选项</code> - <code>设置</code><br>在<code>CMake Tools configuration</code>中找到<code>cmake.debugConfig</code>，生成设置：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">"cmake.debugConfig": &#123;</span><br><span class="line">        "miDebuggerPath": "gdb.exe",    // Windows 下指定gdb路径（已添加到PATH）</span><br><span class="line">        "externalConsole": true,    // 使用外部控制台</span><br><span class="line">        "stopAtEntry": false    // 在起点处停顿（噢！在这停顿！）</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>
<h4 id="Start-Debugging"><a href="#Start-Debugging" class="headerlink" title="Start Debugging"></a>Start Debugging</h4><p><img src="http://upload-images.jianshu.io/upload_images/1704151-17331ef7f920259d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="藏起来的Debug按钮"></p>
<p>刚Build完你可能看不到这两个按钮：<br><img src="http://upload-images.jianshu.io/upload_images/1704151-67b3db806fd578be.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="调试按钮"><br>其实他们藏起来了… 这应该是个Bug，我已经反馈给作者了。</p>
<p>重启VSCode后他们就会出现，或者直接点那两个藏起来的按钮（还有这种操作？！）：<strong>先点右边选择调试目标</strong>，再点左边开始调试。</p>
<h4 id="合影留念"><a href="#合影留念" class="headerlink" title="合影留念"></a>合影留念</h4><p><img src="http://upload-images.jianshu.io/upload_images/1704151-229ee65ae58f18f6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="完结撒花"></p>
<hr>
<hr>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>Code Everywhere, Build Everywhere.<br>这样的搭配是不是很爽呢？除了MinGW是Windows特有的矫情外。其余的在任何平台都是一样的。虽说现在VSCode和上面的大部分插件都运行的不太稳定，但是我还是很喜欢这种组合进行跨平台的轻量级开发的。</p>
<hr>
<h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><ul>
<li>####Q: VSCode或编译器找不到头文件?<br>A: 如果VSCode用绿色波浪线给你划出那些找不到源的代码时，将鼠标停留在波浪线上，然后会出现一个小    灯泡。点“<strong>Add include path to settings.</strong>”。然后它会自动帮你建立一个名为“c_cpp_properties.json”的文件。<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">"name": "Mac",</span><br><span class="line">"includePath": [</span><br><span class="line">    "$&#123;workspaceRoot&#125;",</span><br><span class="line">    "/usr/include",</span><br><span class="line">    <span class="string">"/usr/local/include"</span></span><br><span class="line">],</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>你会在其中找到类似上述代码块的地方，根据“name”后面所描述的系统，在其下的“includePath”中手动添加头文件目录。<strong>JSON语法</strong>。</p>
<ul>
<li><p>####Q: 为什么路径动不动就写成<code>${fileDirname}/${fileBasenameNoExtension}.out</code>?<br>A: 这样做的好处就是可以在同一配置下进行多个单文件的编译开发，不用每次生成和调试的时候都去写配置文件。使用场景嘛，主要就是写写算法题之类的。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-cda05dce5f441b24.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="我写算法题时的目录结构"><br><code>.out</code>后缀名就是自己瞎起的。不同平台的可执行后缀名都不一样，这样写就跟谁都不沾边了…</p>
</li>
<li><p>####Q: 如果我不用<code>vector-of-bool.cmake-tools</code>插件，要如何Build?<br>A: 写完<code>CMakeLists.txt</code>后，打开VSCode中自带的终端（点击底边栏的输出按钮）</p>
</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/1704151-2163844177906bf7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="输出按钮"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1704151-60a5774f0a3207b1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="终端"><br>键入：<code>cmake .</code>会生成系统对应的项目（如果你是Windows并安装了Visual Studio，他就会生成VS项目）。<br>若想生成<code>MinGW Makefiles</code>则键入<code>cmake -G &quot;MinGW Makefiles&quot; .</code>（注意区分大小写），之后会为你生成makefiles，然后再键入<code>make</code>（若没制作前面所提到的<code>mingw32-make.exe</code>的名为<code>make.exe</code>的副本，则键入<code>mingw32-make</code>），最终生成可执行文件。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://code.visualstudio.com/docs/languages/cpp" target="_blank" rel="noopener">Doc: C/C++ for VS Code (Preview)</a></li>
<li><a href="http://www.hahack.com/codes/cmake/" target="_blank" rel="noopener">CMake 入门实战</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/jessehao/jessehao.github.io.git/jessehao.github.io/2017/02/10/scm-practice-IOT-ESP8266/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jesse Hao">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/jessehao.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zeriodical">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/jessehao.github.io/2017/02/10/scm-practice-IOT-ESP8266/" class="post-title-link" itemprop="url">51单片机实战：物联网初步のESP8266无线网络模块</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-02-10 16:44:00" itemprop="dateCreated datePublished" datetime="2017-02-10T16:44:00+08:00">2017-02-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-03-01 15:26:05" itemprop="dateModified" datetime="2019-03-01T15:26:05+08:00">2019-03-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/jessehao.github.io/categories/扯会儿单片机开发/" itemprop="url" rel="index"><span itemprop="name">扯会儿单片机开发</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="文章框架"><a href="#文章框架" class="headerlink" title="文章框架"></a>文章框架</h2><p><img src="http://upload-images.jianshu.io/upload_images/1704151-609b22e6e121c72c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="文章框架"></p>
<hr>
<hr>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>扯单一周目BOSS出现！请速速讨伐！<br>ESP8266是我第一个，也是唯一一个接触过的无线网络模块，我非常喜欢！大部分网上的教程都是ARM架构单片机配用ESP8266。我比较抠门，给大家上51版的。<br>我记得当时和老板承诺可以做成无线通信的时候我也不是很确定，心里一直打鼓。好在最后做出来了，很有成就感！所以今天的代码案例是我把我之前在公司写的项目代码简化之后分享给大家的。虽然结构有点恶心，但应该还是入得了眼的。<br>如果有没看懂的地方，大家评论区告诉我。</p>
<h4 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h4><p>利用ESP8266芯片，通过无线网络同电脑建立TCP连接。接收电脑传来的消息并显示在LCD上。</p>
<blockquote>
<p>每条信息以<code>\</code>结尾。<br>每条信息字符数不超过32。<br>信息内容只能是ASCII表内的字符。</p>
</blockquote>
<hr>
<h2 id="清单"><a href="#清单" class="headerlink" title="清单"></a>清单</h2><h4 id="硬件"><a href="#硬件" class="headerlink" title="硬件"></a>硬件</h4><h5 id="学习板"><a href="#学习板" class="headerlink" title="学习板"></a>学习板</h5><ul>
<li><p><strong>简介</strong><br>由于这次要用到WIFI模块，没法用Proteus模拟，所以就上真家伙。<br>自己焊板子就太麻烦了，所以就买学习板（其实我不会焊）。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-ed82df554d71a4d5.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="QX-MINI51"><br>这是我入的学习板，你也可以入其他的，如果把握不大就跟我入一样的。<br>这个是我在淘宝上小挑了一阵子选的板子：QX-MINI51。尺寸不大不小，想玩的基本都有。配备的单片机是STC89C52。</p>
<p><a href="https://item.taobao.com/item.htm?spm=a1z10.1-c-s.w4004-6543279843.5.cC5KBR&amp;id=41542952683" target="_blank" rel="noopener">淘宝链接</a></p>
</li>
<li><p><strong>电路</strong><br>下面是QX-MINI51在本节会用到的电路图<br><img src="http://upload-images.jianshu.io/upload_images/1704151-75dc38c117bf8676.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="STC89C52"><br>使用89C52芯片，和我们之前用的单片机一样。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-f346ebbe339d23b1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="供电&amp;USB串口"><br><strong>CH340</strong>芯片是用于普通串口和USB转换的，其上的<code>RXD</code>为串口输入，<code>TXD</code>为串口输出。<code>UD+</code>和<code>UD-</code>对应USB数据线。<br>虽说是用了USB，其实和普通串口通信线用法一致，只是人家成品方便我们使用封装成了USB。这里不深究。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-0a3824357b24fa41.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="流水灯"><br>流水灯在本节中的角色是辅助调试（具体的看后面），这里有用的信息就是让你知道这8个流水灯接哪了。</p>
</li>
</ul>
<h5 id="ESP8266"><a href="#ESP8266" class="headerlink" title="ESP8266"></a>ESP8266</h5><ul>
<li><strong>简介</strong><br>主角，简而言之就是Wi-Fi模块，属于网络层以上的设备。拥有MAC地址和IP地址，支持UDP和TCP。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-8de7324867b0290c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ESP8266"><br>这款的型号是ESP8266-01，其他的和QX-MINI51配合使用不太方便。<br><a href="https://detail.tmall.com/item.htm?spm=a1z10.3-b.w4011-3079905380.27.lQdNY6&amp;id=522820720009&amp;rn=8960987bc1c2fb5aa8a9a66a9c6e179b&amp;abbucket=8" target="_blank" rel="noopener">淘宝链接</a></li>
<li><strong>参数</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">型号</th>
<th style="text-align:center">主芯片</th>
<th style="text-align:center">无线标准</th>
<th style="text-align:center">工作电压</th>
<th style="text-align:center">安全机制</th>
<th style="text-align:center">支持模式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">ESP8266-01</td>
<td style="text-align:center">ESP8266</td>
<td style="text-align:center">IEEE 802.11b/g/n</td>
<td style="text-align:center">3.3V</td>
<td style="text-align:center">WEP/WPA-PSK/WPA2-PSK</td>
<td style="text-align:center">STA、AP、STA+AP</td>
</tr>
</tbody>
</table>
<blockquote>
<p>STA 模式：ESP8266模块通过路由器连接互联网，手机或电脑通过互联网实现对设备的远程控制。<br>AP 模式：ESP8266模块作为热点，实现手机或电脑直接与模块通信，实现局域网无线控制。<br>STA+AP 模式：两种模式的共存模式，即可以通过互联网控制可实现无缝切换，方便操作。</p>
</blockquote>
<p><img src="http://upload-images.jianshu.io/upload_images/1704151-21ad94ea7f5929be.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="引脚图"><br>上图对8个针脚进行说明。</p>
<table>
<thead>
<tr>
<th style="text-align:center">UTXD</th>
<th style="text-align:center">GND</th>
<th style="text-align:center">CH_PD</th>
<th style="text-align:center">GPIO2</th>
<th style="text-align:center">GPIO16</th>
<th style="text-align:center">GPIO0</th>
<th style="text-align:center">VCC</th>
<th style="text-align:center">URXD</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">发送</td>
<td style="text-align:center">接地</td>
<td style="text-align:center">高电平工作</td>
<td style="text-align:center">\</td>
<td style="text-align:center">\</td>
<td style="text-align:center">\</td>
<td style="text-align:center">电源</td>
<td style="text-align:center">接收</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>本例只用到这五个引脚（画“\”的不用），其他引脚的说明资料请自行到淘宝链接处下载。</p>
<ul>
<li><p><strong>AT指令</strong><br>操作ESP8266芯片是靠AT指令的，类似之前的操作LCD1602（《<a href="http://www.jianshu.com/p/c994aa660874" target="_blank" rel="noopener">51单片机实战：液晶显示器のLCD1602</a>》）。操作LCD1602的指令都是一个字节的十六进制码，比较难记和理解。AT指令是字符串形式的指令，一般都是单词缩写，对可笑的人类比较友好。<br>之前和LCD1602交互是靠并口传输，而这次是用串口传输（串口传输简例：《<a href="http://www.jianshu.com/p/ce7b8f409585" target="_blank" rel="noopener">51单片机实战：与计算机异步串行通信</a>》），所以这次的Wi-Fi通信是建立在串口通信基础上的。</p>
<p><a href="http://pan.baidu.com/s/1mi9FwX6" target="_blank" rel="noopener">AT指令集下载链接</a><br><a href="http://pan.baidu.com/s/1o7F0HUM" target="_blank" rel="noopener">AT指令使用示例下载链接</a></p>
</li>
<li><p><strong>波特率</strong><br>注意，这个模块的默认波特率是<code>115200</code>，<strong>本例也是根据这个波特率进行演示的</strong>。若想改变波特率请使用以下语句进行修改：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AT+CIOBAUD=&lt;baudrate&gt;,&lt;databits&gt;,&lt;stopbits&gt;,&lt;parity&gt;,&lt;flow control&gt;</span><br></pre></td></tr></table></figure>
<p>如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AT+CIOBAUD=9600,8,1,0,0</span><br></pre></td></tr></table></figure>
<h4 id="软件"><a href="#软件" class="headerlink" title="软件"></a>软件</h4><table>
<thead>
<tr>
<th style="text-align:center">程序</th>
<th style="text-align:left">说明</th>
<th style="text-align:center">下载</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">UartAssist</td>
<td style="text-align:left">串口调试助手，用来给单片机发送消息</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1mig8GE8" target="_blank" rel="noopener">度娘网盘</a></td>
</tr>
<tr>
<td style="text-align:center">NetAssist</td>
<td style="text-align:left">网络调试助手，在电脑端建立TCP连接与单片机的ESP8266进行通信</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1geHGPIr" target="_blank" rel="noopener">度娘网盘</a></td>
</tr>
<tr>
<td style="text-align:center">STC-ISP</td>
<td style="text-align:left">STC单片机工具集，很强大，可烧录程序，可串口调试等等</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1bpvKAUN" target="_blank" rel="noopener">度娘网盘</a></td>
</tr>
<tr>
<td style="text-align:center">CH340驱动</td>
<td style="text-align:left">CH340的USB驱动，如果没有这个驱动，你的电脑可能识别不到单片机（识别到CH340就相当于识别到单片机的串口。）</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1o879y8U" target="_blank" rel="noopener">度娘网盘</a></td>
</tr>
<tr>
<td style="text-align:center">51单片机波特率初值计算工具</td>
<td style="text-align:left">用于计算在各种波特率和晶振频率等参数下计时器的初值，属于辅助工具，省的还得算。</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1dF5jVod" target="_blank" rel="noopener">度娘网盘</a></td>
</tr>
</tbody>
</table>
<hr>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h4 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h4><p>在开始用单片机直接和无线模块通信之前，首先要绕过单片机直接和无线模块通信以确定其可以使用和接入默认网络（接入一个热点后，模块每次断电后启动都会自动连接该热点），这样可以让单片机少做很多事情（要知道我们用的是51单片机，硬件资源极其有限，能省则省）。</p>
<ul>
<li><p><strong>TXD/RXD反接</strong><br>首先要绕过单片机直接给ESP8266下指令，就要用电脑的串口。但ESP-01是针脚接口，所以我们可以利用QX-MINI51上的针脚和USB接口。</p>
<p>回看前面QX-MINI51的主控芯片和USB的电路图，可以发现，单片机的串口引脚是被并联式的暴露再外的，分别为：<code>P30 - P31</code>和<code>USB</code>，前者为针脚接口，后者为USB接口。且它们的RXD和TXD的数据信息是一摸一样的，注意并不是两个独立的串口，是同一个串口。比方说，单片机要往出发送一个1，P30针脚和USB都会是往出发送一个1。</p>
<p>所以我们利用这个特点，将ESP8266的TXD接到P31（单片机的TXD），RXD接到P30（单片机的RXD），这样就等于让ESP8266直接和USB打交道，也就是和电脑直接打交道了。</p>
<p>为什么叫反接，我一般管RXD对TXD叫正接。嗯…<br><img src="http://upload-images.jianshu.io/upload_images/1704151-71bbf7e81bb6b7ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="接线图"><br>强势秀一波画工！<br>我觉得应该可以看得懂吧，ESP8266的引脚说明请看前面的引脚图。看<strong>红色号码</strong>对应接线，其中4、5、6号引脚不用。</p>
</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/1704151-af9a8c15d6ca1fb5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="实物图"><br>这个图就很难看出线是怎么连的了，所以你要忍受我丑陋的画工。</p>
<ul>
<li><strong>接入网络</strong><br>打开串口调试助手，调好参数<br><img src="http://upload-images.jianshu.io/upload_images/1704151-5645235d3f6539ef.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="串口调试助手，设置参数"><br>其中串口号你连的哪个串口就设置哪个串口号，我是连的COM3。<br>另一个要注意的就是波特率要115200（ESP-01的默认波特率，也可以统一改为9600）。<br>打开串口后，给开发板上电。你的串口调试助手会有信息出来（文本显示，不要十六进制显示）。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?諄MEM CHECK FAIL!!!</span><br><span class="line">d&#123;$弬s</span><br><span class="line">Ai-Thinker Technology Co. Ltd.</span><br><span class="line"></span><br><span class="line">invalid</span><br></pre></td></tr></table></figure>
<p>显示的信息类似上面，你可以先给个测试命令<code>AT</code>看看是否可以接受指令</p>
<blockquote>
<p>注意！每个指令后要跟<strong>回车</strong>再发送！</p>
</blockquote>
<p>如果返回<code>OK</code>则说明指令可以被接收并识别。</p>
<p>如果下面的指令都会返回<code>ERROR</code>（在没有给错指令的情况下），可以尝试<code>AT+RST</code>重启模块。</p>
<p><strong>1. 更改模式</strong><br>指令：<code>AT+CWMODE?</code><br>一般情况下，第一次使用会返回<code>2</code>，也就是AP模式，我们不用它发热点，所以要改回Station模式（模式1）。</p>
<p>指令：<code>AT+CWMODE?</code><br>一般情况下，第一次使用会返回<code>2</code>，也就是AP模式，我们不用它发热点，所以要改回Station模式（模式1）。</p>
<p>指令：<code>AT+CWMODE=1</code><br>返回：<code>OK</code>则成功</p>
<p><strong>2. 接入热点（连Wi-Fi）</strong><br>指令：<code>AT+CWJAP=&lt;SSID&gt;,&lt;Password&gt;</code><br>参数：<ssid>处填写热点名称，<password>处填写密码。两者都要用双引号括起来。<br>例如：<code>AT+CWJAP=&quot;CMCC&quot;,&quot;123456&quot;</code></password></ssid></p>
<p>指令：<code>AT+CWJAP=&lt;SSID&gt;,&lt;Password&gt;</code><br>参数：<ssid>处填写热点名称，<password>处填写密码。两者都要用双引号括起来。<br>例如：<code>AT+CWJAP=&quot;CMCC&quot;,&quot;123456&quot;</code></password></ssid></p>
<p>返回：<code>WIFI CONNECTED</code>：连接到热点<br>返回：<code>WIFI GOT IP</code>：分配到IP，走到这一步，就算已经连入到热点了。</p>
<p>如果忘记SSID了，想看一下可以使用下面的指令，列出广播的SSID（隐藏的不会显示）。<br>指令：<code>AT+CWLAP</code></p>
<p><strong>3. 连接TCP服务器</strong><br>首先打开NetAssist，设置TCP Server，然后建立连接（注意防火墙）。注意，Server必须在Client所在内网或其外网（我的是在同一个内网）。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-b72b32c5bda2e51f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="网络调试助手"></p>
<p>首先打开NetAssist，设置TCP Server，然后建立连接（注意防火墙）。注意，Server必须在Client所在内网或其外网（我的是在同一个内网）。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-b72b32c5bda2e51f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="网络调试助手"></p>
<p>指令：<code>AT+CIPSTART=&lt;Type&gt;,&lt;DomainName&gt;,&lt;Port&gt;</code><br>参数：<type>处写TCP或UDP，<domainname>处写域名，<port>处写端口号。<br>本例：<code>AT+CIPSTART=&quot;TCP&quot;,&quot;192.168.1.110&quot;,1234</code><br>返回：</port></domainname></type></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CONNECT</span><br><span class="line"></span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<p>说明连接成功。<br>在NetAssist中，数据接收框的下面有一个<strong>连接对象</strong>，点开后发现除了<code>All Connections</code>之外，多了一个客户，就确定客户连接到服务器了。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-2212aea56d801257.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="NetAssist"><br>在下方文本框输入信息后发送，可在串口调试助手中看到ESP8266所接收到的信息<br>UartAssist收到的信息：<code>+IPD,10:Hello 简书</code></p>
<p>到这里就说明网络连接及建立TCP都可以顺利完成，在下面的单片机操作中就会变得方便很多。</p>
<blockquote>
<p>注意，ESP8266每次断电后重新上电，最多只会自动连到之前连接的热点，但不会自动连接到TCP服务器，所以，建立连接要交给单片机来做。</p>
</blockquote>
<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><ul>
<li><p><strong>波特率</strong><br>本例要使用的波特率为115200的，不是9600。引申出来的问题就是：算初值（方法详见：<a href="http://www.jianshu.com/p/ce7b8f409585" target="_blank" rel="noopener">《51单片机实战：与计算机异步串行通信》</a> - 知识点 - 波特率 - 溢出率）。<br>手算真的很麻烦，因为在参数固定的情况下，算起来已经很烦了，更何况那些参数可能还会变得情况。<br>所以上神器：<br><img src="http://upload-images.jianshu.io/upload_images/1704151-80e5b4b817077297.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="初值计算器"></p>
</li>
<li><p><strong>反馈及识别</strong><br>我们要做的是让单片机在收到ESP8266回馈的<code>WIFI GOT IP</code>后发出连接TCP服务器的指令。<br>发送指令不用多说，只要记得在后面跟”换行（CR）”和”新行（NL）”字符就行（这两个是不一样的）。<br><strong>1. 关键字符配对</strong><br>如果是电脑程序的高级语言编程，这个问题就不存在了。但是我们给单片机写程序就要牢记它的一些点（<a href="http://www.jianshu.com/p/8141a366cfb1" target="_blank" rel="noopener">《扯会儿单片机开发：开始》</a>），比如硬件资源十分紧张。<br>一个是因为它存储空间很小，另一个是因为晶振太慢，所以我们要想办法缩减配对时间。因为单片机的使用往往很单一，所以策略都是根据情况来设定的。比如本例，单片机接收的回馈无非那么几种，所以我制定的策略就是关键字符配对。</p>
<p>比如识别<code>WIFI GOT IP</code>，我只是别第一个字符<code>W</code>和第6个字符<code>G</code>，就说明我收到的就是这个回馈信息。如果收到第一个是<code>W</code>，只有这条指令的第六个字符是<code>G</code>，所以就可以确定。如果是出现干扰，可能性也是比较低的，我们的交互是在网络层的，下层也可以把出错的报文挡掉。</p>
<p>总体来说还是蛮可靠的，如果你有更棒的方法，请在评论区告诉我，大家一起学习进步。</p>
<p><strong>2. 利用流水灯</strong><br>上面就是理论工作，已经做得7788了。但实际经验告诉我，如果的代码哪里也出岔子了在51单片机开发中真的比较难发现，他不像高级程序语言可以报错，可以<code>try - catch</code>。但这个就别想了，所以我们要自己想办法，让他可以反馈我们的程序至少是正常运行的，这样可以节省很多时间。</p>
<p>我在这里介绍的我的方法是利用LED，或成组的流水灯(更好)。承租的流水灯一般是8个，可以直接显示一个字节的信息，可能有人问为什么不用LCD？你若会LCD或者看过<a href="http://www.jianshu.com/p/c994aa660874" target="_blank" rel="noopener">《51单片机实战：液晶显示器のLCD1602》</a>就会发现，LCD本身的开发就有点复杂了。你很难保证这个子程序运行正常，更别提用它抓错了。只能是不推荐哈，我觉得不可靠。LED的话就很简单了，就是个关开，一般不会出错。</p>
<p>QX-MINI51开发板上自带流水灯，你要是入的其他开发板，一般都是有的。如果没有，就单买LED回来（如果不知道去哪买，<a href="https://detail.tmall.com/item.htm?id=16510017655&amp;spm=a1z09.2.0.0.MFqVsV&amp;_u=9fjektg2576" target="_blank" rel="noopener">链接</a>）。</p>
<p>我一般会怎么做呢，先让流水灯直接显示串口接收的数据，为了知道我们至少是能接收到东西的。然后利用上面的关键字符识别，收到<code>WIFI CONNECTED</code>亮一号灯，收到<code>WIFI GOT IP</code>亮二号灯，收到<code>CONNECT OK</code>亮三号灯。这样，根据灯亮灭的情况就能确定哪一步出了问题，然后定位到代码或者设置。</p>
<p>还是那句话，如果你有更棒的方法，欢迎在评论区交流。</p>
</li>
</ul>
<p>到这里就做完了所有理论上的准备工作，也就是理论上我们已经可以实现这个程序了，下面代码实现。</p>
<hr>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>说下这次代码比较新颖的地方，一个是用到了<code>.c</code>和<code>.h</code>文件组合的模块形式，另一个是用到了<strong>函数指针</strong>（函数名也被括起来的那个）。前者这种写法是为了将各子功能模块化，<code>.h</code>文件里的内容相当于面向对象编程里的<code>public</code>，<code>.c</code>文件一个是实现<code>.h</code>内的函数，另一个就是隐藏函数和变量，相当于<code>private</code>。后者是用来充当高级语言中的“事件”，让函数调用变得更加灵活，其具体用法请自己查资料或者看相关C语言书籍。</p>
<blockquote>
<p>总而言之，这次的代码是<strong>模块化</strong>和<strong>事件化</strong>的，类似<strong>面向对象</strong>的编码风格。</p>
</blockquote>
<ul>
<li><p><strong>准备</strong><br>因为用于通讯，所以我把ASCII内所有的特殊字符都写到一个头文件里。虽然本例只用到其中的几个，但以后重复利用这个头文件。</p>
<p><strong><code>ASCII.h</code></strong></p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __ASCIIS__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __ASCIIS__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUL 0x00 <span class="comment">// NULL</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOH 0x01 <span class="comment">// Start of Heading</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STX 0x02 <span class="comment">// Start of Text</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETX 0x03 <span class="comment">// End of Text</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EOT 0x04 <span class="comment">// End of Transmission</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ENQ 0x05 <span class="comment">// Enquiry</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ACK 0x06 <span class="comment">// Acknowledge</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BEL 0x07 <span class="comment">// Bell</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BS 0x08 <span class="comment">// Backspace</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HT 0x09 <span class="comment">// Horizontal Tab</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LF 0x0A <span class="comment">// Line Feed</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NL 0x0A <span class="comment">// New Line</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VT 0x0B <span class="comment">// Vertical Tab</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FF 0x0C <span class="comment">// Form Feed</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NP 0x0C <span class="comment">// New Page</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CR 0x0D <span class="comment">// Carriage Return</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SO 0x0E <span class="comment">// Shift Out</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SI 0x0F <span class="comment">// Shift In</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DLE 0x10 <span class="comment">// Data Link Escape</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DC1 0x11 <span class="comment">// Device Control 1</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DC2 0x12 <span class="comment">// Device Control 2</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DC3 0x13 <span class="comment">// Device Control 3</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DC4 0x14 <span class="comment">// Device Control 4</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NAK 0x15 <span class="comment">// Negative Acknowledge</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYN 0x16 <span class="comment">// Synchronous Idle</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ETB 0x17 <span class="comment">// End of Transmission Block</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CAN 0x18 <span class="comment">// Cancel</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EM 0x19 <span class="comment">// End of Medium</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SUB 0x1A <span class="comment">// Substitute</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ESC 0x1B <span class="comment">// Escape</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FS 0x1C <span class="comment">// File Separator</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GS 0x1D <span class="comment">// Group Separator</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RS 0x1E <span class="comment">// Record Separator</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> US 0x1F <span class="comment">// Unit Separator</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SP 0x20 <span class="comment">// Space</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>LCD</strong><br>这里都是关于LCD1602显示器的主要代码，与文章<a href="http://www.jianshu.com/p/c994aa660874" target="_blank" rel="noopener">《51单片机实战：液晶显示器のLCD1602》</a>所讲的一样，这里就不给出注释了。</li>
</ul>
<p><strong><code>lcd1602.h</code></strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __LCD1602__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __LCD1602__</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> bit BOOL;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LCD_writeCmd</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> cmd)</span></span>;  <span class="comment">//写命令</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LCD_writeData</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> dat)</span></span>;  <span class="comment">//写数据</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LCD_writeLine</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *line)</span></span>;  <span class="comment">//写行数据</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LCD_init</span><span class="params">()</span></span>;  <span class="comment">//初始化</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delay</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> z)</span></span>;  <span class="comment">//粗略的延时器</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><strong><code>lcd1602.c</code></strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"lcd1602.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LCD_CLEAR 0x01</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LCD_Display_Mode 0X38</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DISPLAY_OFF 0x08</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DISPLAY_ON_NO_CURSOR 0x0c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DISPLAY_ON_WITH_CURSOR_NO_BLINK 0x0e</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DISPLAY_ON_WITH_CURSOR_BLINK 0x0f</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AUTO_BACK_STEP 0x04</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AUTO_NEXT_STEP 0x06</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AUTO_DISPLAY_MOVE_LEFT 0x07</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AUTO_DISPLAY_MOVE_RIGHT 0x05</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ALL_MOVE_LEFT 0x18</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ALL_MOVE_RIGHT 0x1c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CURSOR_MOVE_LEFT 0x10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CURSOR_MOVE_RIGHT 0x14</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIRST_ROW 0x80</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECOND_ROW FIRST_ROW+0x40</span></span><br><span class="line"></span><br><span class="line">sbit enable = P0^<span class="number">5</span>;</span><br><span class="line">sbit RS = P0^<span class="number">7</span>;</span><br><span class="line">sbit RW = P0^<span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delay</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> z)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> x,y;</span><br><span class="line">	<span class="keyword">for</span>(x=z;x&gt;<span class="number">0</span>;x--)</span><br><span class="line">		<span class="keyword">for</span>(y=<span class="number">220</span>;y&gt;<span class="number">0</span>;y--);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LCD_writeCmd</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> cmd)</span></span>&#123;</span><br><span class="line">	RS = <span class="number">0</span>;</span><br><span class="line">	P2 = cmd;</span><br><span class="line">	delay(<span class="number">5</span>);</span><br><span class="line">	enable = <span class="number">1</span>;</span><br><span class="line">	delay(<span class="number">5</span>);</span><br><span class="line">	enable = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LCD_writeData</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> dat)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	RS = <span class="number">1</span>;</span><br><span class="line">	P2 = dat;</span><br><span class="line">	delay(<span class="number">5</span>);</span><br><span class="line">	enable = <span class="number">1</span>;</span><br><span class="line">	delay(<span class="number">5</span>);</span><br><span class="line">	enable = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LCD_writeLine</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *line)</span></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> i=<span class="number">0</span>;</span><br><span class="line">	BOOL flag = <span class="number">0</span>;</span><br><span class="line">	LCD_writeCmd(LCD_CLEAR);  <span class="comment">//每次送来信息都清屏，可以一直刷新显示送来的信息。</span></span><br><span class="line">	LCD_writeCmd(FIRST_ROW);</span><br><span class="line">	<span class="keyword">while</span>(line[i] != <span class="string">'\0'</span>)&#123;</span><br><span class="line">		LCD_writeData(line[i++]);</span><br><span class="line">		<span class="keyword">if</span>(i&gt;<span class="number">15</span> &amp;&amp; flag == <span class="number">0</span>)&#123;</span><br><span class="line">			LCD_writeCmd(SECOND_ROW);</span><br><span class="line">			flag = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		delay(<span class="number">5</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LCD_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	RW = <span class="number">0</span>;</span><br><span class="line">	enable = <span class="number">0</span>;</span><br><span class="line">	LCD_writeCmd(LCD_Display_Mode);</span><br><span class="line">	LCD_writeCmd(DISPLAY_ON_NO_CURSOR);</span><br><span class="line">	LCD_writeCmd(AUTO_NEXT_STEP);</span><br><span class="line">	LCD_writeCmd(LCD_CLEAR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>串口通信</strong><br>这里用于单片机和ESP8266交互，与文章<a href="http://www.jianshu.com/p/ce7b8f409585" target="_blank" rel="noopener">《51单片机实战：与计算机异步串行通信》</a>相似。其中的不同点前面已经说过。</li>
</ul>
<p><strong><code>stc52ser.h</code></strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __STC52_SER__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __STC52_SER__</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="title">void</span> <span class="params">(*SerialPort_Event_ByteReceived)</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> byte)</span></span>;  <span class="comment">//事件：串口接收到字节</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SerialPort_Init_Low</span><span class="params">()</span></span>;  <span class="comment">//初始化为11.0592MHz下的9600波特率</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SerialPort_Init_High</span><span class="params">()</span></span>;  <span class="comment">//初始化为22.1184下的115200波特率</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SerialPort_SendByte</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> byte)</span></span>;  <span class="comment">//发送一个字节</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SerialPort_SendData</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span>* bytes)</span></span>;  <span class="comment">//发送一组字节</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><strong><code>stc52ser.c</code></strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"ASCIIS.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stc52ser.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Byte Received Event</span></span><br><span class="line"><span class="keyword">void</span> (*SerialPort_Event_ByteReceived)(<span class="keyword">unsigned</span> <span class="keyword">char</span> byte);</span><br><span class="line"></span><br><span class="line"><span class="comment">//initialize registers pertinent to serial port</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SerialPort_Init_Low</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="comment">//set and run Timer1</span></span><br><span class="line">	<span class="comment">//mode2: 8bit, auto reload initial value</span></span><br><span class="line">	<span class="comment">//9600bps and 11.0592MHz =&gt; 0xfd(initial value)</span></span><br><span class="line">	TMOD = <span class="number">0x20</span>;</span><br><span class="line">	TH1 = <span class="number">0xfd</span>;</span><br><span class="line">	TL1 = <span class="number">0xfd</span>;</span><br><span class="line">	TR1 = <span class="number">1</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//set serial port configuration and enable receive</span></span><br><span class="line">	<span class="comment">//mode1: asyc 10bit(8 data bit), alterable baud rate</span></span><br><span class="line">	SM0 = <span class="number">0</span>;</span><br><span class="line">	SM1 = <span class="number">1</span>;</span><br><span class="line">	REN = <span class="number">1</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//set interruption</span></span><br><span class="line">	<span class="comment">//enable all and serial port interruption</span></span><br><span class="line">	EA = <span class="number">1</span>;</span><br><span class="line">	ES = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//initialize registers pertinent to serial port for esp8266</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SerialPort_Init_High</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="comment">//SMOD = 1</span></span><br><span class="line">	PCON |= <span class="number">0x80</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//set and run Timer1</span></span><br><span class="line">	<span class="comment">//mode2: 8bit, auto reload initial value</span></span><br><span class="line">	<span class="comment">//115200bps and 22.1184MHz =&gt; 0xfd(initial value)</span></span><br><span class="line">	TMOD = <span class="number">0x20</span>;</span><br><span class="line">	TH1 = <span class="number">0xff</span>;</span><br><span class="line">	TL1 = <span class="number">0xff</span>;</span><br><span class="line">	TR1 = <span class="number">1</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//set serial port configuration and enable receive</span></span><br><span class="line">	<span class="comment">//mode1: asyc 10bit(8 data bit), alterable baud rate</span></span><br><span class="line">	SM0 = <span class="number">0</span>;</span><br><span class="line">	SM1 = <span class="number">1</span>;</span><br><span class="line">	REN = <span class="number">1</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//set interruption</span></span><br><span class="line">	<span class="comment">//enable all and serial port interruption</span></span><br><span class="line">	EA = <span class="number">1</span>;</span><br><span class="line">	ES = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Send a byte</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SerialPort_SendByte</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> byte)</span></span>&#123;</span><br><span class="line">	ES = <span class="number">0</span>;</span><br><span class="line">	SBUF = byte;</span><br><span class="line">	<span class="keyword">while</span>(!TI);</span><br><span class="line">	<span class="comment">// transmit interrupt</span></span><br><span class="line">	TI = <span class="number">0</span>;</span><br><span class="line">	ES = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Send a data of byte sequence end by 'EOT'</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SerialPort_SendData</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span>* bytes)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span>(bytes[i] != EOT)&#123;</span><br><span class="line">		SerialPort_SendByte(bytes[i]);</span><br><span class="line">		i++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//Occured when byte received</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">receivedInterruped</span><span class="params">()</span> interrupt 4 </span>&#123;</span><br><span class="line">	TR0 = <span class="number">0</span>;</span><br><span class="line">	(*SerialPort_Event_ByteReceived)(SBUF);</span><br><span class="line">	<span class="keyword">while</span>(!RI);</span><br><span class="line">	RI = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单说一下，这里留了两个初始化函数，<code>SerialPort_Init_Low()</code>用于11.0592MHz下的9600波特率，<code>SerialPort_Init_High()</code>用于22.1184MHz下的115200波特率（此例用这个）。这样写只是为了以后可以重用（软工狗的矫情）。</p>
<ul>
<li><strong>无线</strong><br>这里是<strong>最主要</strong>的代码，都是关于ESP8266的，也是作为一个模块给主函数调用。</li>
</ul>
<p><strong><code>esp8266.h</code></strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __ESP8266__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __ESP8266__</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="title">void</span> <span class="params">(*ESP01_Event_WifiConnected)</span><span class="params">()</span></span>;    <span class="comment">//事件：Wi-Fi已连接</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="title">void</span> <span class="params">(*ESP01_Event_IpGot)</span><span class="params">()</span></span>;    <span class="comment">//事件：IP地址已获得</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="title">void</span> <span class="params">(*ESP01_Event_TcpServerConnected)</span><span class="params">()</span></span>;    <span class="comment">//事件：已连接到TCP服务器</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="title">void</span> <span class="params">(*ESP01_Event_MsgReceived)</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span>* head)</span></span>;    <span class="comment">//事件：已获得消息，head为消息数组头</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ESP01_Init</span><span class="params">()</span></span>;  <span class="comment">//无线模块初始化</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ESP01_ConnectToTCPServer</span><span class="params">()</span></span>;  <span class="comment">//连接TCP服务器</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><strong><code>esp8266.c</code></strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stc52ser.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"ASCIIS.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"esp8266.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFFER_MAX_SIZE 99  <span class="comment">//缓冲区大小</span></span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> buffer[BUFFER_MAX_SIZE];  <span class="comment">//缓冲区：用于存放从ESP8266接收来的各种信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//连接到TCP服务器的指令：AT+CIPSTART="TCP","192.168.1.110",1234。后面的CR和NL是AT指令的固定结尾，EOT用于SerialPort_SendData发送时识别结尾。</span></span><br><span class="line">code <span class="keyword">unsigned</span> <span class="keyword">char</span> cmd_connectToTCPServer[] = &#123;<span class="number">0x41</span>, <span class="number">0x54</span>, <span class="number">0x2B</span>, <span class="number">0x43</span>, <span class="number">0x49</span>, <span class="number">0x50</span>, <span class="number">0x53</span>, <span class="number">0x54</span>, <span class="number">0x41</span>, <span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x3D</span>, <span class="number">0x22</span>, <span class="number">0x54</span>, <span class="number">0x43</span>, <span class="number">0x50</span>, <span class="number">0x22</span>, <span class="number">0x2C</span>, <span class="number">0x22</span>, <span class="number">0x31</span>, <span class="number">0x39</span>, <span class="number">0x32</span>, <span class="number">0x2E</span>, <span class="number">0x31</span>, <span class="number">0x36</span>, <span class="number">0x38</span>, <span class="number">0x2E</span>, <span class="number">0x31</span>, <span class="number">0x2E</span>, <span class="number">0x31</span>, <span class="number">0x31</span>, <span class="number">0x30</span>, <span class="number">0x22</span>, <span class="number">0x2C</span>, <span class="number">0x31</span>, <span class="number">0x32</span>, <span class="number">0x33</span>, <span class="number">0x34</span>, CR, NL, EOT&#125;;</span><br><span class="line"><span class="keyword">int</span> counter = <span class="number">0</span>;    <span class="comment">//用于ESP8266的执行步骤计数</span></span><br><span class="line"><span class="keyword">int</span> writeIndex = <span class="number">0</span>;    <span class="comment">//缓冲区写索引</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> (*ESP01_Event_WifiConnected)();</span><br><span class="line"><span class="keyword">void</span> (*ESP01_Event_IpGot)();</span><br><span class="line"><span class="keyword">void</span> (*ESP01_Event_TcpServerConnected)();</span><br><span class="line"><span class="keyword">void</span> (*ESP01_Event_MsgReceived)(<span class="keyword">unsigned</span> <span class="keyword">char</span>* head);</span><br><span class="line"></span><br><span class="line"><span class="comment">//注意：下面代码推荐从后往前看，从注释标"1. "处开始。</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepareForData</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> byte)</span></span>;    <span class="comment">//因为第四步和第三步会相互调用，所以这里只是做了个声明（C语言的矫情点）。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//4. 将信息插入到缓冲区并送给单片机。</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">insertDataIntoBuffer</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> byte)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(byte == <span class="string">'\\'</span>)&#123;</span><br><span class="line">        <span class="comment">//检测到'\'后，将信息送出到单片机</span></span><br><span class="line">		buffer[writeIndex] = <span class="string">'\0'</span>;</span><br><span class="line">		(*ESP01_Event_MsgReceived)(buffer);</span><br><span class="line">		SerialPort_Event_ByteReceived = &amp;prepareForData;    <span class="comment">//回到第三步，准备接收下一条信息</span></span><br><span class="line">		writeIndex = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	buffer[writeIndex++] = byte;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//3. 准备信息：这里是过度步骤，前面可以观察到，ESP8266在接收发来的信息时是有个头的，这里的作用就是去头。</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepareForData</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> byte)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(byte == <span class="string">':'</span>)&#123;</span><br><span class="line">		SerialPort_Event_ByteReceived = &amp;insertDataIntoBuffer;</span><br><span class="line">		writeIndex = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//识别回馈指令：用于识别接收到的是WIFI CONNECTED（连上热点）还是WIFI IP GOT（获得IP）还是CONNECT（连上TCP服务器）</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">parseCmd</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span>(counter)&#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">			<span class="keyword">if</span>(buffer[<span class="number">0</span>] == <span class="string">'W'</span> &amp;&amp; buffer[<span class="number">5</span>] == <span class="string">'C'</span>)&#123;</span><br><span class="line">				(*ESP01_Event_WifiConnected)();</span><br><span class="line">				counter += <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">			<span class="keyword">if</span>(buffer[<span class="number">0</span>] == <span class="string">'W'</span> &amp;&amp; buffer[<span class="number">5</span>] == <span class="string">'G'</span>)&#123;</span><br><span class="line">				(*ESP01_Event_IpGot)();</span><br><span class="line">				counter += <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">			<span class="keyword">if</span>(buffer[<span class="number">0</span>] == <span class="string">'A'</span> &amp;&amp; buffer[<span class="number">3</span>] == <span class="string">'C'</span>)</span><br><span class="line">				counter += <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">			<span class="keyword">if</span>(buffer[<span class="number">0</span>] == <span class="string">'C'</span> &amp;&amp; buffer[<span class="number">3</span>] == <span class="string">'N'</span> &amp;&amp; buffer[<span class="number">6</span>] == <span class="string">'T'</span>)&#123;</span><br><span class="line">				(*ESP01_Event_TcpServerConnected)();</span><br><span class="line">				SerialPort_Event_ByteReceived = &amp;prepareForData;  <span class="comment">//连接到TCP服务器后，进入第三步。</span></span><br><span class="line">			&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//2. 这里开始向缓冲区存储信息，用于识别。</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">insertBuffer</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> byte)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(byte == NL)&#123;</span><br><span class="line">        <span class="comment">//收到尾（NL）后，将缓冲区的回馈信息送去识别</span></span><br><span class="line">		parseCmd();</span><br><span class="line">		writeIndex = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	buffer[writeIndex++] = byte;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1. 接收头：头是无用信息，但我们要通过头里面的一些字符，推算出什么时候到达第二步（WIFI CONNECTED）</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">headerReceived</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> byte)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(byte == NL)&#123;</span><br><span class="line">        <span class="comment">//头内有5个NL，只要数够5个，下一个就是第二步的内容了。</span></span><br><span class="line">		<span class="keyword">if</span>(++counter == <span class="number">5</span>)&#123;</span><br><span class="line">			SerialPort_Event_ByteReceived = &amp;insertBuffer;  <span class="comment">//跳到第二步</span></span><br><span class="line">			counter = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//同.h中的声明</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ESP01_Init</span><span class="params">()</span></span>&#123;</span><br><span class="line">	SerialPort_Init_High();</span><br><span class="line">	SerialPort_Event_ByteReceived = &amp;headerReceived;  <span class="comment">//事件注册</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//同.h中的声明</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ESP01_ConnectToTCPServer</span><span class="params">()</span></span>&#123;</span><br><span class="line">	SerialPort_SendData(cmd_connectToTCPServer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>主函数</strong></li>
</ul>
<p><strong><code>main.c</code></strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"lcd1602.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"esp8266.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//连接到Wi-Fi后，亮第一个灯</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EventHandler_WifiConnected</span><span class="params">()</span></span>&#123;</span><br><span class="line">	P1 &amp;= <span class="number">0xFE</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获得IP后，亮第二个灯</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EventHandler_IpGot</span><span class="params">()</span></span>&#123;</span><br><span class="line">	P1 &amp;= <span class="number">0xFD</span>;</span><br><span class="line">	ESP01_ConnectToTCPServer();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//连接到TCP服务器后，亮第三个灯</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EventHandler_TcpServerConnected</span><span class="params">()</span></span>&#123;</span><br><span class="line">	P1 &amp;= <span class="number">0xFB</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//将ESP8266送来的信息，送去LCD显示。</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EventHandler_MsgReceived</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span>* head)</span></span>&#123;</span><br><span class="line">	LCD_writeLine(head);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">	ESP01_Event_WifiConnected = &amp;EventHandler_WifiConnected;  <span class="comment">//事件注册</span></span><br><span class="line">	ESP01_Event_IpGot = &amp;EventHandler_IpGot;  <span class="comment">//事件注册</span></span><br><span class="line">	ESP01_Event_TcpServerConnected = &amp;EventHandler_TcpServerConnected;  <span class="comment">//事件注册</span></span><br><span class="line">	ESP01_Event_MsgReceived = &amp;EventHandler_MsgReceived;  <span class="comment">//事件注册</span></span><br><span class="line">	ESP01_Init();</span><br><span class="line">	LCD_init();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	init();</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>编译</strong><br>编译前要设置一下目标参数，如下图。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-51033594c9bd5321.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="目标设置"><br>注意这里要改成XDATA，不然编译通不过的。</li>
</ul>
<hr>
<h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p>开始前请确定在同一个网络下，并且服务端已开启。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1704151-88481580b7552b82.gif?imageMogr2/auto-orient/strip" alt="初始化效果"><br>我只是把单片机连到移动电源上了。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1704151-d191d56c414e2e4a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="服务端"><br>为了能让1602第一行显示<code>Hello</code>，第二行显示<code>World</code>，中间可以留了11个空格。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1704151-5e63ca7e86fb3488.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="客户端"></p>
<hr>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>猴！到这里这个程序就算完成了。这个比那些用手机控制开关灯要复杂一些。所以你只要掌握了这个例子，那些都不在话下了。<br>扯单一周目BOSS正式刷完，这个系列的文章将会暂告一段落，因为接下来笔者又要去考试了，还有什么噼里啪啦科三学车，烦。消失一小阵子后我会再次诈尸的！</p>
<p>恭喜你获得一周目BOSS神装：物联网神技！</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/jessehao/jessehao.github.io.git/jessehao.github.io/2017/01/29/scm-practice-serial-port-communication-with-computer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jesse Hao">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/jessehao.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zeriodical">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/jessehao.github.io/2017/01/29/scm-practice-serial-port-communication-with-computer/" class="post-title-link" itemprop="url">51单片机实战：与计算机异步串行通信</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-01-29 22:07:00" itemprop="dateCreated datePublished" datetime="2017-01-29T22:07:00+08:00">2017-01-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-03-01 15:23:30" itemprop="dateModified" datetime="2019-03-01T15:23:30+08:00">2019-03-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/jessehao.github.io/categories/扯会儿单片机开发/" itemprop="url" rel="index"><span itemprop="name">扯会儿单片机开发</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="文章框架"><a href="#文章框架" class="headerlink" title="文章框架"></a>文章框架</h2><p><img src="http://upload-images.jianshu.io/upload_images/1704151-0f1b77c97c08c60a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="文章框架"></p>
<hr>
<hr>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>猴！今儿扯串口，相对于并行——一口气全把数据扔过去，串行显得更加稳重——一位一位来。<br>串行就是这样，只需要一条数据线（全双工和同步串行时两条），一位一位的传过去。为了让大家在直到你是在给我传数据而不是外面的噪音或者是胡说八道，所以串行数据的各位要组装帧（看正文中的<strong>帧格式</strong>）。乍一看，这种方式跟并行比肯定慢的一腿。但实际上，多亏了它的稳定性，可以在波特率极高的情况下依然保持稳定，这是并行所办不到的（传的快了或距离远了就张牙舞爪了），所以发展到现在，串口已经把并口甩走几条街啦。</p>
<p>并口传输的例子：<a href="http://www.jianshu.com/p/c994aa660874" target="_blank" rel="noopener">《51单片机实战：液晶显示器のLCD1602》</a></p>
<p>除此之外，串行传输分同步和异步。同步除了传输数据外，还要传输时钟信号，以保持双方同步。另一种，异步，就没这么麻烦了，也是本例中要讲到的，各自走各自的时钟就好，只要帧格式和波特率都商量好是一样的就好。</p>
<hr>
<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h4 id="电平"><a href="#电平" class="headerlink" title="电平"></a>电平</h4><table>
<thead>
<tr>
<th style="text-align:center">电平</th>
<th style="text-align:center">高电平</th>
<th style="text-align:center">低电平</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">TTL</td>
<td style="text-align:center">+5V</td>
<td style="text-align:center">0V</td>
<td style="text-align:left">Transistor–Transistor Logic。常用于<strong>设备内部</strong>的数据传输，10英尺内。</td>
</tr>
<tr>
<td style="text-align:center">RS-232C</td>
<td style="text-align:center">-12V</td>
<td style="text-align:center">+12V</td>
<td style="text-align:left">RS（recommended standard）代表推荐标准，232是标识号，C代表RS232的最新一次修改（1969），用于<strong>计算机串口</strong></td>
</tr>
</tbody>
</table>
<p>电平之前在文章<a href="http://www.jianshu.com/p/c994aa660874" target="_blank" rel="noopener">《51单片机实战：液晶显示器のLCD1602》</a>中介绍过，那里只说了TTL，本例中由于要和计算机打交道，所以多了一种电平：RS-232C</p>
<p>在单片机中是TTL，电脑那边传出和接收都是RS232，所以两种电平需要作转换。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-311d3a17e64304e4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="MAX232"><br>当当当！它就是干这活的。</p>
<table>
<thead>
<tr>
<th style="text-align:center">T#IN</th>
<th style="text-align:center">T#OUT</th>
<th style="text-align:center">R#IN</th>
<th style="text-align:center">R#OUT</th>
<th style="text-align:center">VS</th>
<th style="text-align:center">C</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">TTL输入</td>
<td style="text-align:center">TTL输出</td>
<td style="text-align:center">RS232输入</td>
<td style="text-align:center">RS232输出</td>
<td style="text-align:center">电源</td>
<td style="text-align:center">接电容</td>
</tr>
</tbody>
</table>
<p>举个栗子，比如单片机从T1IN输入TTL电平，转换好的RS232电平就从R1OUT输出。其他的照猫画虎，这里不详细说这个东西，因为咱们在Proteus里干活，用不着转换（Proteus光环）。</p>
<p>####波特率（Baud Rate）<br>在此描述串行传输数据速率。<br>正儿八经的说，波特率乃<strong>码元</strong>的传输速率，即每秒传输的码元个数（码元可以是任意进制的），并不是什么每秒传输的比特数，大家注意。<br>波特来源于一个人的名字：<a href="https://en.wikipedia.org/wiki/%C3%89mile_Baudot" target="_blank" rel="noopener">Jean-Maurice-Émile <strong>Baud</strong>ot</a>，因此简写为Baud，单位符号：Bd。波特率可简写成Bd/s。</p>
<p>在串口通信中，其码元就是二进制信号，所以波特率的数值等于比特率数值，但你不能说波特率就是比特率啊！</p>
<p>单片机的串口通信有四种方式（各方式具体是干什么的，别着急，在后面），其中方式0和方式2的波特率是固定的。方式1和方式3的波特率是可变的，其脉冲周期由定时器1溢出产生。</p>
<table>
<thead>
<tr>
<th style="text-align:center">方式</th>
<th style="text-align:center">波特率</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center"><code>f</code> / 12</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">((2^<code>SMOD</code>) / 32) × （T1溢出率）</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">((2^<code>SMOD</code>) / 64) × <code>f</code></td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">((2^<code>SMOD</code>) / 32) × （T1溢出率）</td>
</tr>
</tbody>
</table>
<p>其中<code>f</code>是系统晶振频率，T1是计时器1，<code>SMOD</code>是PCON中的最高位（PCON见相关寄存器的第一个）。</p>
<p>可以从上述公式看出，波特率不可变是因为直接与系统晶振频率相关（晶振频率不可变，除非换晶振），而可变是因为直接与T1的溢出率相关（溢出率可以改变）。</p>
<p><strong>溢出率</strong><br>在之前定时器应用的例子（<a href="http://www.jianshu.com/p/90ea43a7b4fd" target="_blank" rel="noopener">《51单片机实战：定时器与数码管的应用》</a>）中，我们计算的是溢出周期，也就是多长时间会溢出一次。这次我们用到的溢出率其实是同一个东西，取倒数就可以了。</p>
<p>详见：<a href="http://www.jianshu.com/p/90ea43a7b4fd" target="_blank" rel="noopener">《51单片机实战：定时器与数码管的应用》</a> - <strong>知识点</strong> - <strong>定时器/计数器</strong> - <strong>初值</strong></p>
<ul>
<li><p><strong>使用定时器1的方式2</strong></p>
<p>定时器的方式2是一个自动重装初值的8位定时器。低8位（TLX）用于自加计时，高8位（THX）保存每次自动重装的初值。</p>
<p>所以，用于产生脉冲周期的定时器的<br><code>溢出周期</code> = [(2^8) - <code>i</code>] × 12 / <code>f</code><br>其中， <code>i</code>为定时器初值，<code>f</code>还是晶振频率。</p>
<p><code>溢出率</code> = 1 / <code>溢出周期</code></p>
</li>
</ul>
<p><strong>11.0592MHz</strong><br>为什么要用这么蹩脚的数字作晶振频率哈，就是跟这里有关。如果你已经用上述公式计算过串口方式1下的12MHz和11.0592MHz在9600波特率下的定时器初值，你就会发现，前者得出一个小数，而后者是个整数。<br>我们可没办法用小数赋初值，所以你若用近似的整数作初值，就意味着会产生误差。</p>
<ul>
<li>常用：<code>11.0592MHz</code> &amp; <code>9600Bd</code> ⇒ <code>THX = TLX = 0xfd</code></li>
</ul>
<p>若用其他的晶振和波特率的话，请自行按前面的公式计算。</p>
<h4 id="帧格式"><a href="#帧格式" class="headerlink" title="帧格式"></a>帧格式</h4><p>串行传输按比特来，一个个比特组成一个帧，帧需要一定的格式才能被双方识别这是一个帧信息。</p>
<table>
<thead>
<tr>
<th style="text-align:center">S</th>
<th style="text-align:center">D</th>
<th style="text-align:center">P</th>
<th style="text-align:center">E</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">起始位</td>
<td style="text-align:center">数据位</td>
<td style="text-align:center">奇偶校验位</td>
<td style="text-align:center">终止位</td>
</tr>
<tr>
<td style="text-align:center">标明帧头</td>
<td style="text-align:center">数据信息</td>
<td style="text-align:center">用于检验此帧是否出错</td>
<td style="text-align:center">标明帧尾</td>
</tr>
<tr>
<td style="text-align:center">1位，低电平</td>
<td style="text-align:center">可以是5、6、7、8位</td>
<td style="text-align:center">可加可不加，可奇校验也可偶校验</td>
<td style="text-align:center">可以是1、1/2、2位，高电平</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="相关寄存器"><a href="#相关寄存器" class="headerlink" title="相关寄存器"></a>相关寄存器</h2><h4 id="PCON"><a href="#PCON" class="headerlink" title="PCON"></a>PCON</h4><p><strong>电源管理</strong>寄存器，用于管理单片机的电源部分。<br>字节地址：<code>87H</code>，不能位寻址，<code>reg52.h</code>中已定义，单片机复位时全部清零。</p>
<table>
<thead>
<tr>
<th style="text-align:center">位</th>
<th style="text-align:center">7</th>
<th style="text-align:center">6</th>
<th style="text-align:center">5</th>
<th style="text-align:center">4</th>
<th style="text-align:center">3</th>
<th style="text-align:center">2</th>
<th style="text-align:center">1</th>
<th style="text-align:center">0</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">符号</td>
<td style="text-align:center">SMOD</td>
<td style="text-align:center">（SMOD0）</td>
<td style="text-align:center">（LVDF）</td>
<td style="text-align:center">（P0F）</td>
<td style="text-align:center">GF1</td>
<td style="text-align:center">GF0</td>
<td style="text-align:center">PD</td>
<td style="text-align:center">IDL</td>
</tr>
<tr>
<td style="text-align:center">说明</td>
<td style="text-align:center">串口方式为1、2、3时，设置串口波特率的速率</td>
<td style="text-align:center">STC单片机特有功能</td>
<td style="text-align:center">STC单片机特有功能</td>
<td style="text-align:center">STC单片机特有功能</td>
<td style="text-align:center">通用工作标志位</td>
<td style="text-align:center">通用工作标志位</td>
<td style="text-align:center">掉电模式</td>
<td style="text-align:center">空闲模式</td>
</tr>
<tr>
<td style="text-align:center">值</td>
<td style="text-align:center">0：正常；1：加倍</td>
<td style="text-align:center">\</td>
<td style="text-align:center">\</td>
<td style="text-align:center">\</td>
<td style="text-align:center">\</td>
<td style="text-align:center">\</td>
<td style="text-align:center">1：进入掉电模式</td>
<td style="text-align:center">1：进入空闲模式</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>上表中出现的“串口方式”见下表的SM0和SM1。</p>
<h4 id="SCON"><a href="#SCON" class="headerlink" title="SCON"></a>SCON</h4><p><strong>串口控制</strong>寄存器，用于设定串口工作方式。<br>字节地址：<code>98H</code>，可位寻址，<code>reg52.h</code>中已定义，单片机复位时全部清零。</p>
<table>
<thead>
<tr>
<th style="text-align:center">位</th>
<th style="text-align:center">7</th>
<th style="text-align:center">6</th>
<th style="text-align:center">5</th>
<th style="text-align:center">4</th>
<th style="text-align:center">3</th>
<th style="text-align:center">2</th>
<th style="text-align:center">1</th>
<th style="text-align:center">0</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">符号</td>
<td style="text-align:center">SM0</td>
<td style="text-align:center">SM1</td>
<td style="text-align:center">SM2</td>
<td style="text-align:center">REN</td>
<td style="text-align:center">TB8</td>
<td style="text-align:center">RB8</td>
<td style="text-align:center">TI</td>
<td style="text-align:center">RI</td>
</tr>
<tr>
<td style="text-align:center">说明</td>
<td style="text-align:center">工作方式选择位</td>
<td style="text-align:center">工作方式选择位</td>
<td style="text-align:center">多机通信控制位</td>
<td style="text-align:center">允许串行接收位</td>
<td style="text-align:center">方式2、3时，发送数据的第9位</td>
<td style="text-align:center">方式2、3时，接收数据的第9位</td>
<td style="text-align:center">发送中断标志</td>
<td style="text-align:center">接收中断标志</td>
</tr>
<tr>
<td style="text-align:center">值</td>
<td style="text-align:center">看下表</td>
<td style="text-align:center">看下表</td>
<td style="text-align:center">与本例无关懒得说</td>
<td style="text-align:center">1：允许串口接收数据</td>
<td style="text-align:center">\</td>
<td style="text-align:center">\</td>
<td style="text-align:center">第八位发送结束时，硬件置1</td>
<td style="text-align:center">第八位接收结束时，硬件置1</td>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:center">SM0</th>
<th style="text-align:center">SM1</th>
<th style="text-align:center">方式</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">同步移位寄存器方式</td>
</tr>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">10位异步收发（8数据位），波特率可变</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">2</td>
<td style="text-align:center">11位异步收发（9数据位），波特率固定</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">3</td>
<td style="text-align:center">11位异步收发（9数据位），波特率可变</td>
</tr>
</tbody>
</table>
<p>上表中波特率可变的方式，都由定时器1的溢出率控制。</p>
<hr>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><h4 id="需求说明"><a href="#需求说明" class="headerlink" title="需求说明"></a>需求说明</h4><p>当单片机接收到字符<code>a</code>时，点亮一个LED灯。传送方式：9600波特率，8数据位，无校验位，1停止位。</p>
<h4 id="程序清单"><a href="#程序清单" class="headerlink" title="程序清单"></a>程序清单</h4><p>本例中我就不写电脑端程序了，直接用现成的。</p>
<table>
<thead>
<tr>
<th style="text-align:center">程序</th>
<th style="text-align:left">说明</th>
<th style="text-align:center">下载</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">VSPD</td>
<td style="text-align:left">Visual Serial Port Driver，用于建立虚拟串口连接，因为我们还是用Proteus模拟接口，所以需要VSPD模拟串口之间连接起来</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1jIMAhmu" target="_blank" rel="noopener">度娘网盘</a></td>
</tr>
<tr>
<td style="text-align:center">UartAssist</td>
<td style="text-align:left">串口调试助手，用来给单片机发送消息</td>
<td style="text-align:center"><a href="http://pan.baidu.com/s/1mig8GE8" target="_blank" rel="noopener">度娘网盘</a></td>
</tr>
</tbody>
</table>
<h4 id="电路"><a href="#电路" class="headerlink" title="电路"></a>电路</h4><p><img src="http://upload-images.jianshu.io/upload_images/1704151-7f4bb709256bdfdf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="电路"></p>
<p>注意，这里面我没有放转换电平转换芯片（MAX232），只有在Proteus里可以这么干，现实中焊板子还是要做电平转换的，这里这个软件给简化了。</p>
<p><strong>COMPIM</strong><br><img src="http://upload-images.jianshu.io/upload_images/1704151-90aa93b0a092d5d9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="COMPIM"><br>乃虚拟9Pin串口，模拟前记得要设置参数。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-eabf87291b30bb86.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="参数设置"><br>注意，波特率要设置虚拟波特率那个，物理波特率在本例中没用。</p>
<p><strong>虚拟终端</strong><br>右下角那个东西是虚拟终端（Virtual Terminal），他可以直接截获串口传来的消息然后显示出来。很方便做这方面调试时使用。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-4c931470d9e747f4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Virtual Terminal"></p>
<p>路径：<code>边栏</code> → <code>instruments</code> → <code>virtual terminal</code></p>
<p>如果在调试的时候不小心把它的终端窗口关了，再次打开路径：<code>菜单</code> → <code>debug</code> - <code>virtual terminal</code>，注意是在启动调试的情况下。</p>
<h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> uchar unsigned char</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> uint unsigned int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> a;  <span class="comment">//用于从缓冲区中接收数据，虽然在此例中显得有点多此一举，但最好还是把东西放到自家变量中放心。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">	a = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定时器初始化</span></span><br><span class="line">	TMOD = <span class="number">0x20</span>;  <span class="comment">//定时器1的方式2</span></span><br><span class="line">	TH1 = <span class="number">0xfd</span>;</span><br><span class="line">	TL1 = <span class="number">0xfd</span>;</span><br><span class="line">	TR1 = <span class="number">1</span>;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//串口初始化，方式1</span></span><br><span class="line">	SM0 = <span class="number">0</span>;</span><br><span class="line">	SM1 = <span class="number">1</span>;</span><br><span class="line">	REN = <span class="number">1</span>;  <span class="comment">//允许接收</span></span><br><span class="line">	</span><br><span class="line">	EA = <span class="number">1</span>;  <span class="comment">//中断总闸·开！</span></span><br><span class="line">	ES = <span class="number">1</span>;  <span class="comment">//串口中断·开！</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	init();</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">com</span><span class="params">()</span> interrupt 4</span>&#123;</span><br><span class="line">	a = SBUF; <span class="comment">//SBUF为串口接收缓冲区</span></span><br><span class="line">	<span class="keyword">while</span>(!RI);  <span class="comment">//判断接收是否完毕</span></span><br><span class="line">	<span class="keyword">if</span>(a == <span class="number">0x61</span>)  <span class="comment">//如果是'a'，亮灯</span></span><br><span class="line">		P0 = <span class="number">0</span>;</span><br><span class="line">	RI = <span class="number">0</span>;  <span class="comment">//准备下一次接收</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h4><ul>
<li><p><strong>发送<code>c</code></strong><br><img src="http://upload-images.jianshu.io/upload_images/1704151-5cf75a0d3fae58d1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="调试助手发送数据"><br>注意这里串口调试助手中的通讯设置那一块，要和Proteus中COMPIM元件保持一致。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-c72d2cd54a58ab70.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Proteus"><br>可以看出发送<code>c</code>后，端口正确收到了<code>c</code>，但并没有亮灯。</p>
</li>
<li><p><strong>发送<code>a</code></strong><br><img src="http://upload-images.jianshu.io/upload_images/1704151-2d17b4e1cc3c7eec.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Proteus"><br>收到<code>a</code>后，亮灯。</p>
</li>
</ul>
<hr>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>大年初二，拜访完姥姥家就该看看单片机怎么玩，你说是吧！这两天快马加鞭了，下一站：一周目大BOSS。各位加油。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/jessehao/jessehao.github.io.git/jessehao.github.io/2017/01/27/scm-practice-LCD1602/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jesse Hao">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/jessehao.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zeriodical">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/jessehao.github.io/2017/01/27/scm-practice-LCD1602/" class="post-title-link" itemprop="url">51单片机实战：液晶显示器のLCD1602</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-01-27 22:34:00" itemprop="dateCreated datePublished" datetime="2017-01-27T22:34:00+08:00">2017-01-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-03-01 15:20:32" itemprop="dateModified" datetime="2019-03-01T15:20:32+08:00">2019-03-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/jessehao.github.io/categories/扯会儿单片机开发/" itemprop="url" rel="index"><span itemprop="name">扯会儿单片机开发</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="文章框架"><a href="#文章框架" class="headerlink" title="文章框架"></a>文章框架</h2><p><img src="http://upload-images.jianshu.io/upload_images/1704151-68f770d416d00fe6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="文章框架"></p>
<hr>
<hr>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>好吧，最终我还是决定把LCD和串口通信分开写。</p>
<p>首先祝各位新春快乐，鸡年大吉。上班的事业有成，上学的天天向上。过大年呢，还真没啥心情码字。</p>
<p>借着爆竹声咱扯会儿LCD（液晶显示器，Liquid Crystal Display）。今天要实战的这款俗称为LCD1602，尤其注意这个1602，他说明了这款显示器的显示能力：每行16个字符，共2行，乃字符显示器（仅ASCII）。</p>
<hr>
<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><table>
<thead>
<tr>
<th style="text-align:center">显示容量</th>
<th style="text-align:center">芯片工作电压</th>
<th style="text-align:center">工作电流</th>
<th style="text-align:center">模块最佳工作电压</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">16×2 Char</td>
<td style="text-align:center">4.5~5.5V</td>
<td style="text-align:center">2.0mA(5.0V)</td>
<td style="text-align:center">5.0V</td>
</tr>
</tbody>
</table>
<h4 id="引脚"><a href="#引脚" class="headerlink" title="引脚"></a>引脚</h4><table>
<thead>
<tr>
<th style="text-align:center">Vss</th>
<th style="text-align:center">Vdd</th>
<th style="text-align:center">VO</th>
<th style="text-align:center">RS</th>
<th style="text-align:center">R/W</th>
<th style="text-align:center">E</th>
<th style="text-align:center">D0~7</th>
<th style="text-align:center">BLA</th>
<th style="text-align:center">BLK</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">接地</td>
<td style="text-align:center">正极</td>
<td style="text-align:center">对比度调节</td>
<td style="text-align:center">数据(H)/命令(L)选择端</td>
<td style="text-align:center">读(H)/写(L)选择端</td>
<td style="text-align:center">使能(Enable)信号</td>
<td style="text-align:center">数据口</td>
<td style="text-align:center">背光电源正极</td>
<td style="text-align:center">背光电源负极</td>
</tr>
</tbody>
</table>
<p>LCD上也有一个单片机，用于控制屏幕显示。我们并不是直接操作那块屏幕，而是与那个单片机交互。<br>其中D0~7这8个数据口就是用于交互的，为<strong>并行传输</strong>。</p>
<h4 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h4><p>因为我们要和LCD内嵌的单片机交互，所以需要指令。下面所列的东西都是当RS为低<strong>电平时</strong>发送的（若为高电平，就识别为数据）。</p>
<ul>
<li><strong>数据指针</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">第一行</th>
<th style="text-align:center">第二行</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0x80</td>
<td style="text-align:center">0xC0 (0x80+0x40)</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>显示相关</strong></li>
</ul>
<p>模式：</p>
<table>
<thead>
<tr>
<th style="text-align:center">指令</th>
<th style="text-align:center">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0x38</td>
<td style="text-align:center">设置16×2显示，5x7点阵，8位数据接口</td>
</tr>
</tbody>
</table>
<p>方式：</p>
<table>
<thead>
<tr>
<th style="text-align:center">0</th>
<th style="text-align:center">0</th>
<th style="text-align:center">0</th>
<th style="text-align:center">0</th>
<th style="text-align:center">1</th>
<th style="text-align:center">D</th>
<th style="text-align:center">C</th>
<th style="text-align:center">B</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">\</td>
<td style="text-align:center">\</td>
<td style="text-align:center">\</td>
<td style="text-align:center">\</td>
<td style="text-align:center">\</td>
<td style="text-align:center">Display，1：开显示</td>
<td style="text-align:center">Cursor，1：显示光标</td>
<td style="text-align:center">Blink，1：光标闪烁</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:center">0</th>
<th style="text-align:center">0</th>
<th style="text-align:center">0</th>
<th style="text-align:center">0</th>
<th style="text-align:center">0</th>
<th style="text-align:center">1</th>
<th style="text-align:center">N</th>
<th style="text-align:center">S</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">\</td>
<td style="text-align:center">\</td>
<td style="text-align:center">\</td>
<td style="text-align:center">\</td>
<td style="text-align:center">\</td>
<td style="text-align:center">\</td>
<td style="text-align:center">Next，1：读/写一个字符后，指针自动加1</td>
<td style="text-align:center">Shift，1：写字符时，相对字符静止的屏幕移动</td>
</tr>
</tbody>
</table>
<p>清屏：</p>
<table>
<thead>
<tr>
<th style="text-align:center">指令</th>
<th style="text-align:center">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0x01</td>
<td style="text-align:center">数据指针清0且所有指针清空</td>
</tr>
<tr>
<td style="text-align:center">0x02</td>
<td style="text-align:center">仅数据指针清0</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>操作</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">指令</th>
<th style="text-align:center">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0x10</td>
<td style="text-align:center">光标左移</td>
</tr>
<tr>
<td style="text-align:center">0x14</td>
<td style="text-align:center">光标右移</td>
</tr>
<tr>
<td style="text-align:center">0x18</td>
<td style="text-align:center">整体左移</td>
</tr>
<tr>
<td style="text-align:center">0x1c</td>
<td style="text-align:center">整体右移</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="电平"><a href="#电平" class="headerlink" title="电平"></a>电平</h2><p>简单说下，逻辑电路中只有高电平和低电平，也就是程序里面的1和0。但是在物理层面上，它需要一个具体的表现，然后整理成标准。<br><strong>TTL</strong>就是本例中要用到的一种电平，单片机和LCD通过引脚传递电信号，从而达到1和0的传递。<br>TTL中的低电平（0）表现为0V，高电平（1）表现为5V</p>
<hr>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><h4 id="界内显示"><a href="#界内显示" class="headerlink" title="界内显示"></a>界内显示</h4><ul>
<li><strong>电路</strong></li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/1704151-a6258ebf752d74a9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="电路"></p>
<p>在Proteus里，1602就是<code>LM016L</code>，除了没有背光灯电源外用法一致(<code>VEE</code>是对比度调节，本例不用)。<br><code>RP1</code>为上拉电阻，用于提高电压。由于这款单片机的P0引脚组的电压低于5V，所以需要上拉至5V，达到TTL的标准。<br>那个圆形的刻着<code>Volts</code>字样的东西是电压表，连接两个没被上拉电压的P0引脚，具体数值看后面的演示图。</p>
<ul>
<li><strong>代码</strong></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> uchar unsigned char</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> uint unsigned int</span></span><br><span class="line">	</span><br><span class="line"><span class="comment">//coefficient of 1602 display(16 row 2 col. 5*7px per Char)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LCD_CLEAR 0x01      <span class="comment">//宏定义：清屏</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DISPLAY_MODE_1602 0x38  <span class="comment">//宏定义：1602显示模式</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DISPLAY_OFF 0x08  <span class="comment">//宏定义：关显示</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DISPLAY_ON_NO_CURSOR 0x0c  <span class="comment">//宏定义：开显示且无光标</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DISPLAY_ON_WITH_CURSOR_NO_BLINK 0x0e  <span class="comment">//宏定义：开显示且有光标但不闪烁</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DISPLAY_ON_WITH_CURSOR_BLINK 0x0f  <span class="comment">//宏定义：开显示且有光标且闪烁</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AUTO_BACK_STEP 0x04  <span class="comment">//宏定义：读/写时指针自动减1</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AUTO_NEXT_STEP 0x06  <span class="comment">//宏定义：读/写时指针自动加1</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AUTO_DISPLAY_MOVE_LEFT 0x07  <span class="comment">//宏定义：字符相对静止，整屏左移</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AUTO_DISPLAY_MOVE_RIGHT 0x05  <span class="comment">//宏定义：字符相对静止，整屏右移</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ALL_MOVE_LEFT 0x18  <span class="comment">//宏定义：屏幕左移</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ALL_MOVE_RIGHT 0x1c  <span class="comment">//宏定义：屏幕右移</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CURSOR_MOVE_LEFT 0x10  <span class="comment">//宏定义：光标左移</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CURSOR_MOVE_RIGHT 0x14  <span class="comment">//宏定义：光标右移</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIRST_ROW 0x80  <span class="comment">//宏定义：第一行头地址</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SECOND_ROW FIRST_ROW+0x40  <span class="comment">//宏定义：第二行头地址</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">uchar code fst[] = <span class="string">"Hello World!"</span>;  <span class="comment">//第一行要显示的数据数组</span></span><br><span class="line">uchar code sec[] = <span class="string">""</span>;  <span class="comment">//第二行要显示的数据数组</span></span><br><span class="line">uchar num;  <span class="comment">//字符计数</span></span><br><span class="line">sbit enable = P0^<span class="number">5</span>;  <span class="comment">//使能端</span></span><br><span class="line">sbit RS = P0^<span class="number">7</span>;  <span class="comment">//数据/命令切换</span></span><br><span class="line">sbit RW = P0^<span class="number">6</span>;  <span class="comment">//读/写切换</span></span><br><span class="line"></span><br><span class="line">sbit anode = P0^<span class="number">0</span>;  <span class="comment">//连接电压表阳极</span></span><br><span class="line">sbit cathode = P0^<span class="number">1</span>;  <span class="comment">//连接电压表阴极</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//粗制的延时器，没走一次这个函数大约为1ms，适用于11.0592MHz及附近</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delay</span><span class="params">(uint z)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	uint x,y;</span><br><span class="line">	<span class="keyword">for</span>(x=z;x&gt;<span class="number">0</span>;x--)</span><br><span class="line">		<span class="keyword">for</span>(y=<span class="number">110</span>;y&gt;<span class="number">0</span>;y--);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//写命令</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeCmd</span><span class="params">(uchar cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	RS = <span class="number">0</span>;  <span class="comment">//切换为写命令模式</span></span><br><span class="line">	P2 = cmd;</span><br><span class="line">	delay(<span class="number">1</span>);  <span class="comment">//注意</span></span><br><span class="line">	enable = <span class="number">1</span>;  <span class="comment">//执行！</span></span><br><span class="line">	delay(<span class="number">1</span>);  <span class="comment">//注意</span></span><br><span class="line">	enable = <span class="number">0</span>; <span class="comment">//执行完毕！</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeDat</span><span class="params">(uchar dat)</span></span>&#123;</span><br><span class="line">	RS = <span class="number">1</span>; <span class="comment">//切换为数据模式</span></span><br><span class="line">	P2 = dat;</span><br><span class="line">	delay(<span class="number">1</span>);  <span class="comment">//注意</span></span><br><span class="line">	enable = <span class="number">1</span>;</span><br><span class="line">	delay(<span class="number">1</span>);  <span class="comment">//注意</span></span><br><span class="line">	enable = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">	anode = <span class="number">1</span>;</span><br><span class="line">	cathode = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	RW = <span class="number">0</span>;  <span class="comment">//写模式，本例只往LCD写数据</span></span><br><span class="line">	enable = <span class="number">0</span>;</span><br><span class="line">	writeCmd(DISPLAY_MODE_1602);  <span class="comment">//发送命令：1602模式</span></span><br><span class="line">	writeCmd(DISPLAY_ON_WITH_CURSOR_BLINK);  <span class="comment">//发送命令：开始显示并闪烁光标</span></span><br><span class="line">	writeCmd(AUTO_NEXT_STEP);  <span class="comment">//发送命令：数据指针自动加1</span></span><br><span class="line">	writeCmd(LCD_CLEAR);  <span class="comment">//发送命令：清屏</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	init();</span><br><span class="line">	writeCmd(FIRST_ROW);  <span class="comment">//发送命令：开始从第一行写入</span></span><br><span class="line">	<span class="keyword">for</span>(num=<span class="number">0</span>;num&lt;=<span class="number">12</span>;num++)&#123;</span><br><span class="line">		writeDat(fst[num]);  <span class="comment">//发送数据，每次一字节</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>好，说一下上面代码中标<code>//注意</code>的地方，全都是<code>delay(1)</code>。<br>为了什么呢，不是蛋疼，是因为单片机给LCD传送信号时，数据是要放在数据线上的，要是LCD还没读完单片机给它发的啥就把内容撤走的话，就会造成数据丢失。<br>就是这个道理，为了传输稳定，所以延时一小会儿。这个延时的数值需要大家自己去试，并不一定所有的情况都延时大约1ms就够的。</p>
<ul>
<li><strong>效果</strong></li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/1704151-44fcaae3443786b9.gif?imageMogr2/auto-orient/strip" alt="GIF.gif"></p>
<h4 id="越界显示"><a href="#越界显示" class="headerlink" title="越界显示"></a>越界显示</h4><p>本例用于显示字符数超过16个的情况。<br><strong>代码改动</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uchar code fst[] = <span class="string">"1234567890ABCDEF"</span>;  <span class="comment">//第一行要显示的数据数组</span></span><br><span class="line">uchar code sec[] = <span class="string">"1234567890ABCDEFGHIJK"</span>;  <span class="comment">//第二行要显示的数据数组</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>初始化函数</strong></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">	anode = <span class="number">1</span>;</span><br><span class="line">	cathode = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	RW = <span class="number">0</span>;</span><br><span class="line">	enable = <span class="number">0</span>;</span><br><span class="line">	writeCmd(DISPLAY_MODE_1602);</span><br><span class="line">	writeCmd(DISPLAY_ON_NO_CURSOR);  <span class="comment">//换成不闪的，虽然跟这个新需求没什么联系，就是给你演示下效果</span></span><br><span class="line">	writeCmd(AUTO_NEXT_STEP);</span><br><span class="line">	writeCmd(LCD_CLEAR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>主函数</strong></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	init();</span><br><span class="line">	writeCmd(FIRST_ROW);  <span class="comment">//发送命令：开始从第一行写入</span></span><br><span class="line">	<span class="keyword">for</span>(num=<span class="number">0</span>;num&lt;=<span class="number">16</span>;num++)&#123;</span><br><span class="line">		writeDat(fst[num]);</span><br><span class="line">	&#125;</span><br><span class="line">	writeCmd(SECOND_ROW);  <span class="comment">//发送命令：开始从第二行写入</span></span><br><span class="line">	<span class="keyword">for</span>(num=<span class="number">0</span>;num&lt;=<span class="number">20</span>;num++)&#123;</span><br><span class="line">		writeDat(sec[num]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="comment">//向左移动三次，每次间隔500ms</span></span><br><span class="line">		<span class="keyword">for</span>(num=<span class="number">0</span>;num&lt;=<span class="number">3</span>;num++) &#123;</span><br><span class="line">			writeCmd(ALL_MOVE_LEFT);  <span class="comment">//发送命令：整屏左移</span></span><br><span class="line">			delay(<span class="number">500</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		delay(<span class="number">1000</span>);  <span class="comment">//暂停大约1s</span></span><br><span class="line">        <span class="comment">//向右移动三次，每次间隔500ms</span></span><br><span class="line">		<span class="keyword">for</span>(num=<span class="number">0</span>;num&lt;=<span class="number">3</span>;num++) &#123;</span><br><span class="line">			writeCmd(ALL_MOVE_RIGHT);  <span class="comment">//发送命令：整屏右移</span></span><br><span class="line">			delay(<span class="number">500</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		delay(<span class="number">3000</span>);  <span class="comment">//暂停大约3s后开始下一轮</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>效果</strong><br><img src="http://upload-images.jianshu.io/upload_images/1704151-9c5ef01c212ce47b.gif?imageMogr2/auto-orient/strip" alt="效果"><br>移屏只移3个字符距离，所以并没有把第二行的<code>K</code>显示出来。</p>
<hr>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>这次单讲LCD的入门应用，送给不爱看春晚的你。前两天搞定了科二考试，年后准备科三了。《扯单》系列的一周目大概还差两三篇就完结了，下集预告：串口应用。好了，看完文章实践实践后就该打麻将打麻将，该放炮仗放炮仗吧！总之大家吃好玩好。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/jessehao/jessehao.github.io.git/jessehao.github.io/2017/01/14/scm-practice-timer-and-LED/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jesse Hao">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/jessehao.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zeriodical">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/jessehao.github.io/2017/01/14/scm-practice-timer-and-LED/" class="post-title-link" itemprop="url">51单片机实战：定时器与数码管的应用</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-01-14 22:56:00" itemprop="dateCreated datePublished" datetime="2017-01-14T22:56:00+08:00">2017-01-14</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-03-01 15:02:27" itemprop="dateModified" datetime="2019-03-01T15:02:27+08:00">2019-03-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/jessehao.github.io/categories/扯会儿单片机开发/" itemprop="url" rel="index"><span itemprop="name">扯会儿单片机开发</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="文章框架"><a href="#文章框架" class="headerlink" title="文章框架"></a>文章框架</h2><p><img src="http://upload-images.jianshu.io/upload_images/1704151-41b598ffd284a928.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="框架脑图"></p>
<hr>
<hr>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>好久不《扯单》了！今儿来一发应用篇：用定时器和数码管做一个单十六进制位的计时器。从去年六月底辞职到现在已经过去半年多了，这方面的东西好像也扔的七七八八了（哭笑）。最近考驾照，需要花半天的时间练车，另半天的时间就是复习，然后总结到这里给需要的朋友参考。我在公司的项目是关于智能仓拣的，为了省成本选择51单片机，为了通信方便也用到了无线通信。所以我的《扯单》系列的第一周目会扯到ESP8266的无线通信部分（对物联网感兴趣的朋友有福，可慢慢等我更新）。<br>今天这部分也算是对《<a href="http://www.jianshu.com/p/10b2b76571a0" target="_blank" rel="noopener">扯会儿单片机开发：中断</a>》的一个应用，顺便也用到了数码管，都是很基本的东西。下一步写通信，先有线的串口通信，我会配合LCD做示范。然后就是一周目BOSS：无线网络(Wi-Fi)通信。</p>
<p>嗯，总之我目前是这么打算的，到时候会不会这样我就不知道了哈（任性到不能自己）。好，下面开始今天的正文。</p>
<hr>
<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h4 id="数码管（7-Segment-Display）"><a href="#数码管（7-Segment-Display）" class="headerlink" title="数码管（7-Segment Display）"></a><a href="https://en.wikipedia.org/wiki/Seven-segment_display" target="_blank" rel="noopener">数码管（7-Segment Display）</a></h4><p>图片来源于百度<br><img src="http://upload-images.jianshu.io/upload_images/1704151-ce4a1da40a7951ae.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="数码管图示"></p>
<p><strong>简介</strong><br>我觉得看完图片我也不用做什么介绍，大家应该都见过这东西，最多最多可能就是不知道它叫数码管。<br>数码管的本质是几个并联的发光二极管（LED）。如果不熟悉发光二极管在单片机中应用的可参考文章：《<a href="http://www.jianshu.com/p/88dfc09e7403" target="_blank" rel="noopener">51单片机实战：Proteus、Keil入门及点亮一个虚拟LED</a>》<br>本篇应用了上图的七段一位数码管，也就是说，它本质上就是由七个发光二极管并联起来组成的。虽说上图的1位数码管是有小数点的，你可以理解为那是第八个LED。但是本篇运用的是Proteus中模拟的数码管，并没有那个小数点，看到后面你就知道啦，但要注意区分。</p>
<p><strong>分类</strong></p>
<ul>
<li><p>共阳（Common Anode）<br><img src="http://upload-images.jianshu.io/upload_images/1704151-d4f252d9173eff5e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Proteus模拟元件：7SEG-COM-ANODE"><br>如图就是Proteus中模拟的共阳数码管，上面单独的那个接线是7个数码管共同的阳极接线，左边七个接线是它们各自的阴极接线，所以你也就理解了“共阳”就是他们的阳极是在一起的。</p>
</li>
<li><p>共阴（Common Cathod）<br><img src="http://upload-images.jianshu.io/upload_images/1704151-b85f48c0aa092bf9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Proteus模拟元件：7SEG-COM-CATHODE"><br>与共阳同理，下面单独的那个接线是7个数码管共同的阴极接线，左边七个接线是他们各自的阳极接线，“共阴”就是他们的阴极是在一起的。</p>
</li>
<li><p>BCD（Binary Coded Decimal Display）<br><img src="http://upload-images.jianshu.io/upload_images/1704151-94c5c4cd83c2fcae.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Proteus模拟元件：7SEG-BCD"><br>这个就比较特殊了，它是四个接线（分别对应十进制数字的8、4、2、1）。他只能显示十六进制的0~15（详细请自查阅二进制、十进制、十六进制的转换，这里不作讨论），也就是0、1、2、3、4、5、6、7、8、9、A、b（大写的没法区分）、C、d（大写的没法区分）、E、F。所以如果只作上述十六进制数字的表示，这个操作起来最方便，但是没有灵活性，不像共阳和共阴的可以表示很多鬼畜的东西出来。</p>
</li>
</ul>
<p><strong>演示</strong><br>你看了BCD可能还清楚要怎么给它数据，但共阳共阴的哪知道它哪个接线对应哪个LED啊？<br>好，我给你图，有点丑别太在意：<br><img src="http://upload-images.jianshu.io/upload_images/1704151-8e6b8402cc1011b1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="接线与其对应的LED示意图"><br>解释一下哈，这是我用平板画的，圈里面的数字对应的就是上面<strong>分类</strong>中共阳和共阴数码管左侧接线从上到下的次序。旁边的八位二进制数字是代表哪一位控制哪一个LED（第八位没用。共阳0亮1灭，共阴0灭1亮）。<br>下面用Proteus + Keil（若不会使用详见：《<a href="http://www.jianshu.com/p/88dfc09e7403" target="_blank" rel="noopener">51单片机实战：Proteus、Keil入门及点亮一个虚拟LED</a>》）做一个小程序给大家演示一下三者的区别。</p>
<ul>
<li><p>电路<br><img src="http://upload-images.jianshu.io/upload_images/1704151-2d62193e4ff91bf4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="电路"><br>其中左侧的是BCD（Proteus模拟元件：7SEG-BCD），右上为共阳（Proteus模拟元件：7SEG-COM-ANODE），右下为共阴（这个是不带共阴接线的，接起来比较简单，带接线的接起来有点麻烦，但原理一样。Proteus模拟元件：7SEG-DIGITAL）。</p>
</li>
<li><p>代码</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VALUE 0x04	<span class="comment">//对应的二进制为：0000 0100</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	P0 = VALUE;		<span class="comment">//连接电路中的共阳数码管</span></span><br><span class="line">	P1 = VALUE;		<span class="comment">//连接电路中的BCD</span></span><br><span class="line">	P2 = VALUE;		<span class="comment">//连接电路中的共阳数码管</span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>);		  <span class="comment">//让单片机运行卡在这里，为了一直运行，不然数码管都会灭掉，大家以后写程序也要注意</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>#define</code>为预编译指令中的宏定义指令，只由编译器解释，译为将文中所有的<code>VALUE</code>替换为<code>0x04</code>。关于其二进制<code>0000 0100</code>可以回头看一下那个丑不拉几的草图。</p>
<ul>
<li>效果<br><img src="http://upload-images.jianshu.io/upload_images/1704151-0b5130b9d890b468.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="效果"><br>可以看出共阳和共阴都是对LED亮灭的操作，且正好相反。而BCD可以直接解读你给的数字。所以如果我们用共阳或共阴的数码管显示信息，就需要在代码中制作一个编码表。</li>
</ul>
<h4 id="定时器-计数器"><a href="#定时器-计数器" class="headerlink" title="定时器/计数器"></a>定时器/计数器</h4><p><strong>简介</strong><br>首先，“定时器/计数器”说的是一个东西，因为它既能计时也能计数。其次，它与数码管不一样，不是独立出来的配件，而是存在于单片机内部的一个独立的硬件部分，依赖晶振产生固定的时间间隔，产生了一定量的固定时间间隔后会引发定时器中断（参见：《<a href="http://www.jianshu.com/p/10b2b76571a0" target="_blank" rel="noopener">扯会儿单片机开发：中断</a>》），从而将其产生的时间信息传送给由CPU执行的主程序中。<br><strong>相关寄存器</strong></p>
<ul>
<li>TMOD<br>TMOD为定时器/计数器<strong>工作方式</strong>寄存器，用于确定其工作方式和功能选择。<br>字节地址：<code>89H</code>，不能位寻址，<code>reg52.h</code>中已定义，单片机复位时全部清零。</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">位序号</th>
<th style="text-align:center">7</th>
<th style="text-align:center">6</th>
<th style="text-align:center">5</th>
<th style="text-align:center">4</th>
<th style="text-align:center">3</th>
<th style="text-align:center">2</th>
<th style="text-align:center">1</th>
<th style="text-align:center">0</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>位符号</strong></td>
<td style="text-align:center">GATE</td>
<td style="text-align:center">C/T</td>
<td style="text-align:center">M1</td>
<td style="text-align:center">M0</td>
<td style="text-align:center">GATE</td>
<td style="text-align:center">C/T</td>
<td style="text-align:center">M1</td>
<td style="text-align:center">M0</td>
</tr>
</tbody>
</table>
<p>你会发现,低四位和高四位格式是一样的，因为低四位（0~3）用于设置定时器0，高四位（4~7）用于设置定时器1。设置的内容都是GATE、C/T、M1、M0。</p>
<table>
<thead>
<tr>
<th style="text-align:center">GATE</th>
<th style="text-align:center">C/T</th>
<th style="text-align:center">M1M0</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">门控制位</td>
<td style="text-align:center">计数器还是定时器</td>
<td style="text-align:center">工作方式</td>
</tr>
<tr>
<td style="text-align:center">0：仅受TCON的TR位控制。1：由TR和外部中断一起控制。</td>
<td style="text-align:center">0：定时器。1：计数器</td>
<td style="text-align:center"><em>见下表</em></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:center">M1</th>
<th style="text-align:center">M0</th>
<th style="text-align:left">工作方式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:left">方式0，为13位定时器/计数器</td>
</tr>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:left">方式1，为16位定时器/计数器</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:left">方式2，8位初值自动重装的8位定时器/计数器</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:left">方式3，仅适用于T0，分成两个8位计数器，T1停止计数</td>
</tr>
</tbody>
</table>
<ul>
<li>TCON<br>TCON为定时器/计数器<strong>控制</strong>寄存器，用于控制其启动、停止，标志其溢出和中断情况。<br>字节地址：<code>88H</code>，能位寻址，<code>reg52.h</code>中已定义，单片机复位时全部清零。</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">位序号</th>
<th style="text-align:center">7</th>
<th style="text-align:center">6</th>
<th style="text-align:center">5</th>
<th style="text-align:center">4</th>
<th style="text-align:center">3</th>
<th style="text-align:center">2</th>
<th style="text-align:center">1</th>
<th style="text-align:center">0</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>位符号</strong></td>
<td style="text-align:center">TF1</td>
<td style="text-align:center">TR1</td>
<td style="text-align:center">TF0</td>
<td style="text-align:center">TR0</td>
<td style="text-align:center">IE1</td>
<td style="text-align:center">IT1</td>
<td style="text-align:center">IE0</td>
<td style="text-align:center">IT0</td>
</tr>
</tbody>
</table>
<p>高八位与其运行和溢出有关，第八位与外部中断有关。</p>
<p>高八位中：</p>
<table>
<thead>
<tr>
<th style="text-align:center">TF</th>
<th style="text-align:center">TR</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">溢出标志位</td>
<td style="text-align:center">运行控制位</td>
</tr>
<tr>
<td style="text-align:center">溢出时，由硬件置1</td>
<td style="text-align:center">1：启动定时器</td>
</tr>
</tbody>
</table>
<p>TF0和TR0对应定时器0，TF1和TR1对应定时器1。</p>
<p>低八位中：</p>
<table>
<thead>
<tr>
<th style="text-align:center">IE</th>
<th style="text-align:center">IT</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">外部中断请求标志</td>
<td style="text-align:center">外部中断触发方式选择位</td>
</tr>
</tbody>
</table>
<p>IE0与IT0对应外部中断0，IE1与IT1对应外部中断1。因为此例与这里无关，不作详细介绍，有兴趣请自查资料。</p>
<p><strong>初值</strong></p>
<ul>
<li><p>简介<br>定时器的实质是，由机器频率向一个16位寄存器累加，累加满溢出时触发中断。为了产生一个我们想要的时间间隔，比如说1s，所以我们要在这个寄存器里设定一个初值，以至于让它在这个初值上累加可以产生一个1s的倍数。这样我们就得到了稳定的时间间隔。<br>这个寄存器分为<code>TH</code>（高八位）和<code>TL</code>（低八位）。所以我们需要把计算好的初值分成两部分分别放入<code>TH</code>和<code>TL</code>。</p>
</li>
<li><p>过程<br>首先，我们通过单片机的<strong>晶振频率</strong>得知其<strong>时钟周期</strong>，再尤其乘以12得到<strong>机器周期</strong>。每一个机器周期在寄存器内<strong>+1</strong>，直到加满<strong>溢出</strong>产生<strong>中断</strong>。</p>
</li>
<li><p>例子<br>若单片机频率为<code>12Mhz</code>，其时钟周期就是<code>1/12μs</code>，机器周期为<code>1μs</code>，也就是每<code>1μs</code>寄存器<code>+1</code>。16位的寄存器加到溢出最多需要<code>(2^16)-1=65535μs</code>，溢出也需要一个机器周期，所以总共要<code>65536μs</code>。但这个值太别扭，和我们要的1s没什么关系。我们最好让它记<code>50000μs</code>产生一次中断，所以其初值就设为<code>65536-50000=15536</code>。但我们还要将这个值分别放在高八位和低八位，所以要将这个十进制数，转换为4位十六进制数再分开赋值。<br>十进制计算法：<code>TH = 15536/256;</code> <code>TL = 15536%256;</code>，进制计算问题这里不细讨论。<br>这样的话，每<code>50ms</code>就会产生一次中断。我们只要用程序判断其中断<code>20</code>次就记<code>1s</code>。</p>
</li>
</ul>
<hr>
<h2 id="电路"><a href="#电路" class="headerlink" title="电路"></a>电路</h2><p>这里开始进入今天实践正题，虽说电路和上面知识点的电路是一样的，但要记得把单片机的时钟频率（Clock Frequency）要调成12MHz。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-2d62193e4ff91bf4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="电路"></p>
<hr>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>代码部分我分为两个部分，一个是自定义的关于数码管编码表的头文件<code>7seg.h</code>，另一个是主程序源代码文件<code>main.c</code><br><strong>本例要实现的是在12MHz的时钟频率下，每隔一秒数码管显示的数字加一。</strong></p>
<ul>
<li><code>7seg.h</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __7SEG_H__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __7SEG_H__</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//共阳数码管的十六进制数编码表</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> code hexForCommonAnode[] = &#123;</span><br><span class="line">	<span class="number">0x40</span>, <span class="number">0x79</span>, <span class="number">0x24</span>, <span class="number">0x30</span>,</span><br><span class="line">	<span class="number">0x19</span>, <span class="number">0x12</span>, <span class="number">0x02</span>, <span class="number">0x78</span>,</span><br><span class="line">	<span class="number">0x00</span>, <span class="number">0x10</span>, <span class="number">0x08</span>, <span class="number">0x03</span>,</span><br><span class="line">	<span class="number">0x46</span>, <span class="number">0x21</span>, <span class="number">0x06</span>, <span class="number">0x0e</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//共阴数码管的十六进制数编码表</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> code hexForCommonCathode[] = &#123;</span><br><span class="line">	<span class="number">0x3f</span>, <span class="number">0x06</span>, <span class="number">0x5b</span>, <span class="number">0x4f</span>,</span><br><span class="line">	<span class="number">0x66</span>, <span class="number">0x6d</span>, <span class="number">0x7d</span>, <span class="number">0x07</span>,</span><br><span class="line">	<span class="number">0x7f</span>, <span class="number">0x6f</span>, <span class="number">0x77</span>, <span class="number">0x7c</span>,</span><br><span class="line">	<span class="number">0x39</span>, <span class="number">0x5e</span>, <span class="number">0x79</span>, <span class="number">0x71</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>main.c</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;reg52.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;7seg.h&gt;    //包含自定义的编码表头文件</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> THx = (<span class="number">65536</span><span class="number">-50000</span>)/<span class="number">256</span>;    <span class="comment">//存储高八位寄存器初值的临时变量</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> TLx = (<span class="number">65536</span><span class="number">-50000</span>)%<span class="number">256</span>;    <span class="comment">//存储低八位寄存器初值的临时变量</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> counter = <span class="number">0</span>;    <span class="comment">//用于记录产生中断的次数</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> digit = <span class="number">0</span>;      <span class="comment">//用作编码表索引</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化函数：用于初始化各种参数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	TMOD = <span class="number">0x01</span>;    <span class="comment">//设置定时器0，GATE = 0, C/T = 0 , M1M0 = 01(方式1,16位定时器/计数器)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//赋初值</span></span><br><span class="line">	TH0 = THx;</span><br><span class="line">	TL0 = TLx;</span><br><span class="line"></span><br><span class="line">	EA = <span class="number">1</span>;    <span class="comment">//中断总闸·开！</span></span><br><span class="line">	ET0 = <span class="number">1</span>;  <span class="comment">//定时器0中断·开！</span></span><br><span class="line">	TR0 = <span class="number">1</span>;  <span class="comment">//定时器0·运行！</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//刷新函数：每调用一次就更新一次数码表的显示方式。</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span></span>&#123;</span><br><span class="line">	counter = <span class="number">0</span>;    <span class="comment">//中断计数器清零</span></span><br><span class="line">	P0 = hexForCommonAnode[digit];    <span class="comment">//根据索引找编码表，将显示方式的二进制位丢给共阳数码管</span></span><br><span class="line">	P2 = hexForCommonCathode[digit];  <span class="comment">//根据索引找编码表，将显示方式的二进制位丢给共阴数码管</span></span><br><span class="line">	P1 = digit;    <span class="comment">//索引就是要显示的那个数字，可直接丢给BCD显示出来</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//数满后索引（数字）清零</span></span><br><span class="line">	<span class="keyword">if</span>(++digit &gt;= <span class="number">16</span>)</span><br><span class="line">		digit = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//主函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	init();     <span class="comment">//初始化</span></span><br><span class="line">	refresh();  <span class="comment">//先把0显示出来</span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>);   <span class="comment">//卡住</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器0的中断函数：由定时器中断自动调用，你只需要写好中断后要怎么处理就好</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">timeInt_T0</span> <span class="params">()</span> interrupt 1 </span>&#123;</span><br><span class="line">    <span class="comment">//每中断一次都要重新赋初值</span></span><br><span class="line">	TH0 = THx;</span><br><span class="line">	TL0 = TLx;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//记够20次中断后，刷新显示</span></span><br><span class="line">	<span class="keyword">if</span>(++counter == <span class="number">20</span>)</span><br><span class="line">		refresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p><img src="http://upload-images.jianshu.io/upload_images/1704151-dd21385795a9ee0d.gif?imageMogr2/auto-orient/strip" alt="效果"></p>
<hr>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>好了，今天就《扯单》到这里，下次不出意外的话就开始扯串口通信了。如果你对本文有什么感想和意见，欢迎在评论区畅所欲言！关于深度的话，我会慢慢加，不过也是在力所能及的范围内，毕竟只是个软工狗，还请谅解。</p>
<p>本次实践文中加入了小部分的理论知识介绍和文章框架脑图，不知道大家喜不喜欢，有什么想法就在评论区告诉我。</p>
<hr>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>1.《51单片机C语言教程》，郭天祥 著，电子工业出版社</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/jessehao/jessehao.github.io.git/jessehao.github.io/2016/07/01/scm-develop-interrupt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jesse Hao">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/jessehao.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zeriodical">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/jessehao.github.io/2016/07/01/scm-develop-interrupt/" class="post-title-link" itemprop="url">扯会儿单片机开发：中断</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-07-01 22:29:00" itemprop="dateCreated datePublished" datetime="2016-07-01T22:29:00+08:00">2016-07-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-03-01 14:59:42" itemprop="dateModified" datetime="2019-03-01T14:59:42+08:00">2019-03-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/jessehao.github.io/categories/扯会儿单片机开发/" itemprop="url" rel="index"><span itemprop="name">扯会儿单片机开发</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>读到这篇，你最好已经有了一些<a href="http://www.jianshu.com/p/8141a366cfb1" target="_blank" rel="noopener">基础知识</a>和<a href="http://www.jianshu.com/p/88dfc09e7403" target="_blank" rel="noopener">单片机入门编程</a>能力，接下来聊聊中断（<a href="https://en.wikipedia.org/wiki/Interrupt" target="_blank" rel="noopener">Interrupt</a>）。<br>用程序员的角度说，单片机的中断机制有点像面向对象中的<a href="https://msdn.microsoft.com/zh-cn/library/awbftdfh.aspx" target="_blank" rel="noopener">事件</a>，只不过单片机中的这些“事件”是由其他的部件引发。</p>
<hr>
<h2 id="什么是中断"><a href="#什么是中断" class="headerlink" title="什么是中断"></a>什么是中断</h2><p>简而言之，就是打断处理器且让其处理那个打断它的事件。就好像你在玩电脑，然后家里的暖壶响了，这时你会放下眼前的事，去厨房关火。水开了、壶响了就是中断的触发，关掉煤气灶就是中断要处理时的程序。当你关了火就可以继续回来做眼下的事情。中断也是这个道理。</p>
<h4 id="操作系统中断"><a href="#操作系统中断" class="headerlink" title="操作系统中断"></a>操作系统中断</h4><blockquote>
<p>操作系统的发展过程，大体上就是一个想方设法不断提高资源利用率的过程，而提高资源利用率就需要在程序并未使用某种资源的时候，把它对那种资源的占有权释放掉，而这个行为，就需要通过中断实现。</p>
</blockquote>
<p>从上述引段中可以看出，操作系统中的中断机制引入的初衷就是为了提高多道程序设计的资源利用率的。</p>
<h4 id="单片机中断"><a href="#单片机中断" class="headerlink" title="单片机中断"></a>单片机中断</h4><p>在单片机中，换汤不换药，也主要是为了处理发生的中断事件而设定的</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1704151-f071137ff77f6c8d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br>单片机开始运行后，会开始执行主程序中的代码，当遇到中断时，单片机就会暂停读取主程序代码，转而读取中断代码，当执行完中断代码后，继续手下的主程序代码。<br>大部分单片机并没有操作系统，比如笔者最近把玩的51系列。所以也谈不上他们会有多道程序设计，更不用说进程那些概念。因为单片机的大部分用途都是只运行单一一个程序就够了。</p>
<hr>
<h2 id="52单片机"><a href="#52单片机" class="headerlink" title="52单片机"></a>52单片机</h2><p>说回到52单片机，也就是stc89c52或at89c52之类的。</p>
<h4 id="类别"><a href="#类别" class="headerlink" title="类别"></a>类别</h4><p>它有三种中断类型</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>外部中断</td>
<td>比较通用，外部中断引脚收到信号后发生中断</td>
</tr>
<tr>
<td>串口中断</td>
<td>串口RXD引脚收到信号后发生中断，往往是接受够一个字节后触发</td>
</tr>
<tr>
<td>定时器中断</td>
<td>每当定时器计数溢出后触发</td>
</tr>
</tbody>
</table>
<p>共6个中断源，其中2个外部中断源，3个定时器中断源，1个串口中断源。这里仅仅讨论52单片机内的中断设置。</p>
<h4 id="相关寄存器"><a href="#相关寄存器" class="headerlink" title="相关寄存器"></a>相关寄存器</h4><p>中断涉及到两个寄存器，一个是中断允许寄存器（IE，Interrupt Enablement），另一个是中断优先级寄存器（IP，Interrupt Priority）。<br><strong>中断允许寄存器（IE）</strong><br>各中断源的开关，字节地址：A8H（reg52.h中已定义<code>sfr IE = 0xA8;</code>），可以位寻址（A8H~AFH），复位时全部清零。</p>
<table>
<thead>
<tr>
<th style="text-align:center">位序号</th>
<th style="text-align:center">位地址</th>
<th style="text-align:center">位符号</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">D7</td>
<td style="text-align:center">AFH</td>
<td style="text-align:center">EA</td>
<td>全局中断允许位，就像电闸上总闸，是所有开启任何中断的前提，若关闭，则关闭所有中断。</td>
</tr>
<tr>
<td style="text-align:center">D6</td>
<td style="text-align:center">–</td>
<td style="text-align:center">–</td>
<td>这一位为空，无用。</td>
</tr>
<tr>
<td style="text-align:center">D5</td>
<td style="text-align:center">ADH</td>
<td style="text-align:center">ET2</td>
<td>定时器2中断允许位，若打开则允许定时器2溢出后引发中断。</td>
</tr>
<tr>
<td style="text-align:center">D4</td>
<td style="text-align:center">ACH</td>
<td style="text-align:center">ES</td>
<td>串口中断允许位，若打开则允许RXD引脚接受到1个字节的信息后引发中断。</td>
</tr>
<tr>
<td style="text-align:center">D3</td>
<td style="text-align:center">ABH</td>
<td style="text-align:center">ET1</td>
<td>定时器1中断允许位，若打开则允许定时器1溢出后引发中断。</td>
</tr>
<tr>
<td style="text-align:center">D2</td>
<td style="text-align:center">AAH</td>
<td style="text-align:center">EX1</td>
<td>外部中断1中断允许位，若打开则允许外部中断引脚接收信号后引发中断。</td>
</tr>
<tr>
<td style="text-align:center">D1</td>
<td style="text-align:center">A9H</td>
<td style="text-align:center">ET0</td>
<td>定时器0中断允许位，若打开则允许定时器0溢出后引发中断。</td>
</tr>
<tr>
<td style="text-align:center">D0</td>
<td style="text-align:center">A8H</td>
<td style="text-align:center">EX0</td>
<td>外部中断0中断允许位，若打开则允许外部中断引脚接收信号后引发中断。</td>
</tr>
</tbody>
</table>
<p>以上全部位的值为1是打开，0是关。<br><strong>中断优先寄存器（IP）</strong><br>用于设定各中断源的优先级，字节地址B8H（reg52.h中已定义<code>sfr IP = 0xB8;</code>），可以位寻址（B8H~BFH），复位时全部清零。</p>
<table>
<thead>
<tr>
<th style="text-align:center">位序号</th>
<th style="text-align:center">位地址</th>
<th style="text-align:center">位符号</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">D7</td>
<td style="text-align:center">–</td>
<td style="text-align:center">–</td>
<td>这一位为空，无用。</td>
</tr>
<tr>
<td style="text-align:center">D6</td>
<td style="text-align:center">–</td>
<td style="text-align:center">–</td>
<td>这一位为空，无用。</td>
</tr>
<tr>
<td style="text-align:center">D5</td>
<td style="text-align:center">–</td>
<td style="text-align:center">–</td>
<td>这一位为空，无用。</td>
</tr>
<tr>
<td style="text-align:center">D4</td>
<td style="text-align:center">BCH</td>
<td style="text-align:center">PS</td>
<td>串口中断优先级控制位。</td>
</tr>
<tr>
<td style="text-align:center">D3</td>
<td style="text-align:center">BBH</td>
<td style="text-align:center">PT1</td>
<td>定时器1中断优先级控制位。</td>
</tr>
<tr>
<td style="text-align:center">D2</td>
<td style="text-align:center">BAH</td>
<td style="text-align:center">PX1</td>
<td>外部中断1优先级控制位。</td>
</tr>
<tr>
<td style="text-align:center">D1</td>
<td style="text-align:center">B9H</td>
<td style="text-align:center">PT0</td>
<td>定时器0中断优先级控制位。</td>
</tr>
<tr>
<td style="text-align:center">D0</td>
<td style="text-align:center">B8H</td>
<td style="text-align:center">PX0</td>
<td>外部中断0优先级控制位。</td>
</tr>
</tbody>
</table>
<p>以上各位值为1时为高优先级，0位低优先级。<br>52单片机中，供用户设置的有两种优先级，高与低。他们遵循以下<strong>三条规则：</strong></p>
<p><strong>1.低优先级中断源可被高优先级中断源中断，高优先级中断源不能被任何中断源中断。<br>2.一种不论高低的中断源一旦得到响应，与之同级的中断源不可中断它。<br>3.当同时收到几个同优先级的中断源时，响应优先级按其默认中断级别执行。</strong></p>
<h4 id="各中断源默认中断级别及中断序号"><a href="#各中断源默认中断级别及中断序号" class="headerlink" title="各中断源默认中断级别及中断序号"></a>各中断源默认中断级别及中断序号</h4><table>
<thead>
<tr>
<th>中断源</th>
<th style="text-align:center">默认中断级别</th>
<th style="text-align:center">序号（C语言）</th>
</tr>
</thead>
<tbody>
<tr>
<td>外部中断0</td>
<td style="text-align:center">1st</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td>定时器0中断</td>
<td style="text-align:center">2nd</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td>外部中断2</td>
<td style="text-align:center">3rd</td>
<td style="text-align:center">2</td>
</tr>
<tr>
<td>定时器1中断</td>
<td style="text-align:center">4th</td>
<td style="text-align:center">3</td>
</tr>
<tr>
<td>串口中断</td>
<td style="text-align:center">5th</td>
<td style="text-align:center">4</td>
</tr>
<tr>
<td>定时器2中断</td>
<td style="text-align:center">6th</td>
<td style="text-align:center">5</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p>1.《51单片机C语言教程》，郭天祥 著，电子工业出版社<br>2.《操作系统联考复习指导》，王道论坛 组编，电子工业出版社<br>3.《现代操作系统》，Andrew S. Tanenbaum 著，机械工业出版社<br>4.<a href="http://www.diangon.com/wenku/rd/danpianji/201412/00015424.html" target="_blank" rel="noopener">单片机中断的IE和IP寄存器</a>，电工学习网</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/jessehao/jessehao.github.io.git/jessehao.github.io/2016/06/09/scm-practice-proteus-keil-firstLED/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jesse Hao">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/jessehao.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zeriodical">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/jessehao.github.io/2016/06/09/scm-practice-proteus-keil-firstLED/" class="post-title-link" itemprop="url">51单片机实战：Proteus、Keil入门及点亮一个虚拟LED</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-06-09 19:05:00" itemprop="dateCreated datePublished" datetime="2016-06-09T19:05:00+08:00">2016-06-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-03-01 14:08:57" itemprop="dateModified" datetime="2019-03-01T14:08:57+08:00">2019-03-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/jessehao.github.io/categories/扯会儿单片机开发/" itemprop="url" rel="index"><span itemprop="name">扯会儿单片机开发</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>相信你在看完<a href="http://www.jianshu.com/p/8141a366cfb1" target="_blank" rel="noopener">《扯会儿单片机开发：开始》</a>后，对单片机开发的基础知识有了一定的了解。这一次我们来实战一番，在Proteus中模拟一个单片机界的”HelloWorld” — 点亮一个LED。</p>
<hr>
<h2 id="电路"><a href="#电路" class="headerlink" title="电路"></a>电路</h2><p>在我们开始编码之前，要先把电路画好。我们要通过程序去控制一个LED的明灭，所以需要一个单片机和一个LED，当然，还有它们之间说不清道不明的关系。</p>
<h4 id="Proteus"><a href="#Proteus" class="headerlink" title="Proteus"></a>Proteus</h4><p>Proteus软件是英国Lab Center Electronics公司出版的<a href="https://en.wikipedia.org/wiki/Electronic_design_automation" target="_blank" rel="noopener">EDA</a>工具软件。它可以仿真单片机逻辑和元件之间的电路，我们这次写好的单片机程序就是交给它来模拟运行。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-29a0fcccac687ff4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Proteus 8启动画面"><br>我所用的是Proteus 8.4 SP0<br><img src="http://upload-images.jianshu.io/upload_images/1704151-dd008f1e97fc98c6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Proteus 8.4 SP0 启动图标"><br>如果你用的是早期版本，可能启动图标不一样。我之前用的7.8版的Proteus会有两个子程序，如果你的也是的话，点那个ISIS（阿拉胡阿克巴！）就是了。</p>
<h4 id="建项"><a href="#建项" class="headerlink" title="建项"></a>建项</h4><p>现在要做的就是在Proteus中画个可以控制LED的电路出来。</p>
<ol>
<li><strong>打开Proteus</strong><br><img src="http://upload-images.jianshu.io/upload_images/1704151-08d5470e862160f4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="主界面"></li>
<li><strong>建个项目</strong><br>点击主界面中的<code>新建工程</code><br><img src="http://upload-images.jianshu.io/upload_images/1704151-3277feedc35cc563.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="新建第一步：输入名称和设置路径"><br>在<code>名称</code>那里输入项目名称，在<code>路径</code>处设置项目工程文件存储的路径，下一步。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-7b7456d1183b3ffc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="新建第二步：选择原理图"><br>这里我们选择默认<code>DEFAULT</code>，选下一步。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-50e8428f3b9e6735.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="新建第三步：选择模板"><br>选择<code>不创建PCB布板设计</code>，下一步。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-989edce9885c6003.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="新建第三步：选择固件"><br>选择<code>没有固件项目</code>，下一步。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-653ec4228ac9e8d6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="新建第四步：总结"><br>点击<code>完成</code>后建项成功。<br>其实我也是第一次用Proteus 8，之前的版本建项步骤没这么繁琐，我这么说是因为我也不咋知道那些中间的设置项都能干嘛，还没试过（我好水，这样子自己揭露自己真的好嘛）。</li>
</ol>
<h4 id="开始画电路"><a href="#开始画电路" class="headerlink" title="开始画电路"></a>开始画电路</h4><p>创建好项目后如下图所示<br><img src="http://upload-images.jianshu.io/upload_images/1704151-8e60a614cf011a9f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="主编辑界面"></p>
<ul>
<li><strong>列个需要的元件清单</strong><ol>
<li>单片机</li>
<li>LED</li>
<li>电源</li>
</ol>
</li>
</ul>
<p>点击左侧的<code>P</code>添加元件<br><img src="http://upload-images.jianshu.io/upload_images/1704151-6b54c481006af2ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="左侧的`P`"><br>在元器件选择界面中，用<code>关键字</code>搜索我们需要的器件。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-bcddd5d92fda8fff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="元器件选择界面"><br>我们需要一个51单片机，这个项目就选择at89c52吧，输入”c52”搜索。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-945c50d1ab328d52.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="&quot;c52&quot;的搜索结果"><br>中间那里会列出匹配的结果，你可以一个一个选择，然后观察右侧的预览图来确定是不是你要的菜。你还可以在右下角那里选择其封装。在本项目中，我们需要<code>AT89C52</code>这道菜的<code>DIL40</code>的封装。<br>点击<code>确定</code>后，你的鼠标会变成一根儿笔，再点击一下左键，刚才的器件就会出现，然后就可以摆放它的位置了。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-7264bd508f639557.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="准备摆放"><br><img src="http://upload-images.jianshu.io/upload_images/1704151-d42172e83c054c97.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="部署后"><br>然后重复刚才的操作，去找LED。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-6434834844a3353d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="“LED”的搜索结果"><br>可以看到，与LED相关的元件是比较多的。这里我们选择图示中的那款黄色发光二极管<code>LED-YELLOW</code>（模拟的时候，效果会比较明显）。<br>电源的话，就要去另一个地方找了，点一下左边栏的<code>终端模式</code>。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-f37b4ed5f8b8e9e1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"><br>选择列表中的<code>POWER</code>，然后和前面一样，把它画出来。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-ee0441d1cbc7cb5b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="画上LED和电源"><br>途中的小雨伞就是电源。</p>
<p>然后连接它们，画线路。<br>用笔一样的鼠标点击那些触角就可以将他们连接起来。连好后如下图：<br><img src="http://upload-images.jianshu.io/upload_images/1704151-382b894a23cb759d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="需要的电路"><br><strong>注意电源跟LED的哪个引脚连？</strong><br>二极管是固定电流方向的，要按照图中的方式连接，具体为什么就要你自己查<a href="https://en.wikipedia.org/wiki/Diode" target="_blank" rel="noopener">资料</a>了。</p>
<p>到这里我们的第一大步就走完了。</p>
<hr>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h4 id="Keil"><a href="#Keil" class="headerlink" title="Keil"></a>Keil</h4><p>Keil是我们写单片机代码要用到的IDE，它支持汇编、C和C++的编译，还是很不错的。不过，没有代码补全。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-e3552521fea001b8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Keil μ5 的启动画面"><br>选择下载时，要根据你所开发的单片机选择具体的IDE，它分为<a href="http://www.keil.com/download/product/" target="_blank" rel="noopener">ARM、C51、C166、C251</a>四种。你也可以装多个，然后它们会在同一个IDE下显示并使用。</p>
<p>根据我们刚才在电路板上画的是at89c52单片机，所以我们就选用<a href="https://www.keil.com/demo/eval/c51.htm" target="_blank" rel="noopener">C51</a>版本的。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-6266851b1f909e1c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="主界面"></p>
<h4 id="建项-1"><a href="#建项-1" class="headerlink" title="建项"></a>建项</h4><p>点击菜单栏的Project - New μVersion Project<br><img src="http://upload-images.jianshu.io/upload_images/1704151-93ad1966a142111e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="选择工程存储路径"><br>这里选择你的项目工程要存储的路径，他不会像<a href="https://en.wikipedia.org/wiki/Visual_Studio" target="_blank" rel="noopener">Visual Studio</a>或<a href="https://en.wikipedia.org/wiki/Xcode" target="_blank" rel="noopener">Xcode</a>那样帮你为项目或解决方案自动生成文件夹，这个你要注意，你最好自己建一个项目文件夹，然后选择它去存储。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-1fd97a50a32e17ed.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br>项目建立好后，左边栏会显示当前项目的文件结构。然后我们新建源文件，右击<code>Source Group</code>，选择<code>Add New Item to Group &#39;Source Group 1&#39;</code>。添加源文件的前提必须是在一个<code>Group</code>下，这里选择用它默认的<code>Source Group</code>，你也可以自己新建一个<code>Group</code>。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-4959b3f7c70f33f9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br>选择<code>C File (.c)</code>，输入<code>文件名</code>，然后点击<code>Add</code><br><img src="http://upload-images.jianshu.io/upload_images/1704151-5d3b9359696edbd8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="新建窗口"><br>这样我们就添加了一个源代码文件。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-b8b381d6a4d6359f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="添加了源文件"></p>
<h4 id="C代码"><a href="#C代码" class="headerlink" title="C代码"></a>C代码</h4><p>我们要实现功能的代码如下所示。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;reg52.h&gt;</span></span></span><br><span class="line">sbit led = P0^<span class="number">1</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	led = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>一步一步来，首先，第一行所包含的<code>reg52.h</code>文件中定义了52单片机基础的特殊功能寄存器和特殊功能位。其内部的介绍是：</p>
<blockquote>
<p>Header file for generic 80C52 and 80C32 microcontroller.</p>
</blockquote>
<p>可以通过右键<code>reg52.h</code> - <code>Open ducment &lt;reg52.h&gt;</code>打开其文件。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-3f2238d40a86ab87.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br>打开后，可以看到其源码：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">REG52.H</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Header file for generic 80C52 and 80C32 microcontroller.</span></span><br><span class="line"><span class="comment">Copyright (c) 1988-2002 Keil Elektronik GmbH and Keil Software, Inc.</span></span><br><span class="line"><span class="comment">All rights reserved.</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __REG52_H__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __REG52_H__</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*  BYTE Registers  */</span></span><br><span class="line">sfr P0    = <span class="number">0x80</span>;</span><br><span class="line">sfr P1    = <span class="number">0x90</span>;</span><br><span class="line">sfr P2    = <span class="number">0xA0</span>;</span><br><span class="line">sfr P3    = <span class="number">0xB0</span>;</span><br><span class="line">sfr PSW   = <span class="number">0xD0</span>;</span><br><span class="line">sfr ACC   = <span class="number">0xE0</span>;</span><br><span class="line">sfr B     = <span class="number">0xF0</span>;</span><br><span class="line">sfr SP    = <span class="number">0x81</span>;</span><br><span class="line">sfr DPL   = <span class="number">0x82</span>;</span><br><span class="line">sfr DPH   = <span class="number">0x83</span>;</span><br><span class="line">sfr PCON  = <span class="number">0x87</span>;</span><br><span class="line">sfr TCON  = <span class="number">0x88</span>;</span><br><span class="line">sfr TMOD  = <span class="number">0x89</span>;</span><br><span class="line">sfr TL0   = <span class="number">0x8A</span>;</span><br><span class="line">sfr TL1   = <span class="number">0x8B</span>;</span><br><span class="line">sfr TH0   = <span class="number">0x8C</span>;</span><br><span class="line">sfr TH1   = <span class="number">0x8D</span>;</span><br><span class="line">sfr IE    = <span class="number">0xA8</span>;</span><br><span class="line">sfr IP    = <span class="number">0xB8</span>;</span><br><span class="line">sfr SCON  = <span class="number">0x98</span>;</span><br><span class="line">sfr SBUF  = <span class="number">0x99</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  8052 Extensions  */</span></span><br><span class="line">sfr T2CON  = <span class="number">0xC8</span>;</span><br><span class="line">sfr RCAP2L = <span class="number">0xCA</span>;</span><br><span class="line">sfr RCAP2H = <span class="number">0xCB</span>;</span><br><span class="line">sfr TL2    = <span class="number">0xCC</span>;</span><br><span class="line">sfr TH2    = <span class="number">0xCD</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*  BIT Registers  */</span></span><br><span class="line"><span class="comment">/*  PSW  */</span></span><br><span class="line">sbit CY    = PSW^<span class="number">7</span>;</span><br><span class="line">sbit AC    = PSW^<span class="number">6</span>;</span><br><span class="line">sbit F0    = PSW^<span class="number">5</span>;</span><br><span class="line">sbit RS1   = PSW^<span class="number">4</span>;</span><br><span class="line">sbit RS0   = PSW^<span class="number">3</span>;</span><br><span class="line">sbit OV    = PSW^<span class="number">2</span>;</span><br><span class="line">sbit P     = PSW^<span class="number">0</span>; <span class="comment">//8052 only</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*  TCON  */</span></span><br><span class="line">sbit TF1   = TCON^<span class="number">7</span>;</span><br><span class="line">sbit TR1   = TCON^<span class="number">6</span>;</span><br><span class="line">sbit TF0   = TCON^<span class="number">5</span>;</span><br><span class="line">sbit TR0   = TCON^<span class="number">4</span>;</span><br><span class="line">sbit IE1   = TCON^<span class="number">3</span>;</span><br><span class="line">sbit IT1   = TCON^<span class="number">2</span>;</span><br><span class="line">sbit IE0   = TCON^<span class="number">1</span>;</span><br><span class="line">sbit IT0   = TCON^<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  IE  */</span></span><br><span class="line">sbit EA    = IE^<span class="number">7</span>;</span><br><span class="line">sbit ET2   = IE^<span class="number">5</span>; <span class="comment">//8052 only</span></span><br><span class="line">sbit ES    = IE^<span class="number">4</span>;</span><br><span class="line">sbit ET1   = IE^<span class="number">3</span>;</span><br><span class="line">sbit EX1   = IE^<span class="number">2</span>;</span><br><span class="line">sbit ET0   = IE^<span class="number">1</span>;</span><br><span class="line">sbit EX0   = IE^<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  IP  */</span></span><br><span class="line">sbit PT2   = IP^<span class="number">5</span>;</span><br><span class="line">sbit PS    = IP^<span class="number">4</span>;</span><br><span class="line">sbit PT1   = IP^<span class="number">3</span>;</span><br><span class="line">sbit PX1   = IP^<span class="number">2</span>;</span><br><span class="line">sbit PT0   = IP^<span class="number">1</span>;</span><br><span class="line">sbit PX0   = IP^<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  P3  */</span></span><br><span class="line">sbit RD    = P3^<span class="number">7</span>;</span><br><span class="line">sbit WR    = P3^<span class="number">6</span>;</span><br><span class="line">sbit T1    = P3^<span class="number">5</span>;</span><br><span class="line">sbit T0    = P3^<span class="number">4</span>;</span><br><span class="line">sbit INT1  = P3^<span class="number">3</span>;</span><br><span class="line">sbit INT0  = P3^<span class="number">2</span>;</span><br><span class="line">sbit TXD   = P3^<span class="number">1</span>;</span><br><span class="line">sbit RXD   = P3^<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  SCON  */</span></span><br><span class="line">sbit SM0   = SCON^<span class="number">7</span>;</span><br><span class="line">sbit SM1   = SCON^<span class="number">6</span>;</span><br><span class="line">sbit SM2   = SCON^<span class="number">5</span>;</span><br><span class="line">sbit REN   = SCON^<span class="number">4</span>;</span><br><span class="line">sbit TB8   = SCON^<span class="number">3</span>;</span><br><span class="line">sbit RB8   = SCON^<span class="number">2</span>;</span><br><span class="line">sbit TI    = SCON^<span class="number">1</span>;</span><br><span class="line">sbit RI    = SCON^<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  P1  */</span></span><br><span class="line">sbit T2EX  = P1^<span class="number">1</span>; <span class="comment">// 8052 only</span></span><br><span class="line">sbit T2    = P1^<span class="number">0</span>; <span class="comment">// 8052 only</span></span><br><span class="line">             </span><br><span class="line"><span class="comment">/*  T2CON  */</span></span><br><span class="line">sbit TF2    = T2CON^<span class="number">7</span>;</span><br><span class="line">sbit EXF2   = T2CON^<span class="number">6</span>;</span><br><span class="line">sbit RCLK   = T2CON^<span class="number">5</span>;</span><br><span class="line">sbit TCLK   = T2CON^<span class="number">4</span>;</span><br><span class="line">sbit EXEN2  = T2CON^<span class="number">3</span>;</span><br><span class="line">sbit TR2    = T2CON^<span class="number">2</span>;</span><br><span class="line">sbit C_T2   = T2CON^<span class="number">1</span>;</span><br><span class="line">sbit CP_RL2 = T2CON^<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure></p>
<p>可以看到，里面声明了所有基础的功能寄存器、I/O寄存器和各种功能位。<br>还有一点，建议大家在定义自己的头文件的时候也写上<code>#ifndef</code> - <code>#define</code> - <code>#endif</code>这样的结构来保持自己的头文件在全局中保持唯一而不被重复引入。</p>
<p>回头看源码的第二行。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sbit led = P0^<span class="number">1</span>;</span><br></pre></td></tr></table></figure></p>
<p>意思是声明一个位寻址变量，寻址到P0.1引脚。在上面<code>P0</code>的声明中，可以看到它的地址是<code>0x80</code>，这个地址是P0八个引脚起始（也就是P0.0）的地址，这个地址的高四位代表这组I/O引脚的片选地址，低四位表示其内部的位选地址。这里的led的位选地址根据亦或运算符<code>^</code>算出，也就是P0.1的引脚地址。<br><strong>注意，位寻址变量必须在外部定义，不能在内部，<code>sfr</code>也一样。</strong></p>
<p>最后。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    led = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在主函数中执行，使led所指向的特殊功能位置低电平。因为我们之前的电路中LED一端连着电源，也就是高电平，另一端连着单片机的P0.1引脚，所以需要将P0.1置低电平，从而使电路连通。</p>
<p>以上，我们就完成了代码编写工作。</p>
<hr>
<h2 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h2><h4 id="生成HEX文件"><a href="#生成HEX文件" class="headerlink" title="生成HEX文件"></a>生成HEX文件</h4><p>单片机看不懂C，它只读二进制的机器码，所以我们需要Keil生成一个十六进制的HEX文件（十六进制可以说是服务于二进制的，它与二进制可以非常方便地相互转换，其主要用于存储大量的二进制。一位十六进制可以表示4位二进制）。</p>
<p>还是在Keil中，右击<code>Target 1</code> - 选择<code>Options for Target 1</code><br><img src="http://upload-images.jianshu.io/upload_images/1704151-510ce0121c79adc0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br>选择<code>Output</code>选项卡 - 勾上<code>Create Hex File</code> - <code>OK</code><br><img src="http://upload-images.jianshu.io/upload_images/1704151-8f8ef32a586d275c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="目标设置页"></p>
<h4 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h4><p>设置好目标生成选项后，点击左上方的<code>Build</code>（如图按钮）。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-93778545b56a9f82.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br>下方会输出编译信息<br><img src="http://upload-images.jianshu.io/upload_images/1704151-6b2fc8ab4feea7ed.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="编译输出信息"><br>我们可以从中看到：内部数据<code>data</code>、外部数据<code>xdata</code>、代码量<code>code</code>、编译错误和警告<code>0 Error(s), 0Warning(s)</code>还有编译时间<code>Build Time Elapsed:  00:00:01</code>的信息。<br>总的来说，只要<code>0 Error(s)</code>，就说明编译通过了。</p>
<h4 id="导入Proteus中的单片机"><a href="#导入Proteus中的单片机" class="headerlink" title="导入Proteus中的单片机"></a>导入Proteus中的单片机</h4><p>生成好的Hex文件在Keil项目目录下的<code>Objects</code>文件夹中。<br>回到Proteus中，右击at89c52(或双击)唤出设置页。<br><img src="http://upload-images.jianshu.io/upload_images/1704151-cf92fe91e82afa81.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br><img src="http://upload-images.jianshu.io/upload_images/1704151-d7a9b4eda82aac9a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="元件编辑页"></p>
<p>点击<code>Program File</code>右侧的浏览按钮，选择刚才编译出来的Hex文件，然后点击<code>确定</code>。</p>
<h4 id="看看效果"><a href="#看看效果" class="headerlink" title="看看效果"></a>看看效果</h4><p>点击Proteus左下角的‘播放’按钮<br><img src="http://upload-images.jianshu.io/upload_images/1704151-91eb2407d7c1e925.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="播放按钮"><br><img src="http://upload-images.jianshu.io/upload_images/1704151-008a558fffda0883.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="效果"><br>可以看到，小黄灯被我们点亮了。<br><strong>MISSION COMPLETE!</strong></p>
<hr>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>我们从一开始的Proteus建项、画电路，到Keil的建项、编码，再到最后的Keil编译、Proteus模拟。<br>这就是模拟电路的单片机开发的一个完整过程了。嗯，看完这篇文章后你也一定也按捺不住要干个痛了吧！那就赶紧去爽♂爽的实践一番吧。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/jessehao/jessehao.github.io.git/jessehao.github.io/2016/06/03/scm-develop-beginning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jesse Hao">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/jessehao.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zeriodical">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/jessehao.github.io/2016/06/03/scm-develop-beginning/" class="post-title-link" itemprop="url">扯会儿单片机开发：开始</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-06-03 15:47:00" itemprop="dateCreated datePublished" datetime="2016-06-03T15:47:00+08:00">2016-06-03</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-03-01 14:02:44" itemprop="dateModified" datetime="2019-03-01T14:02:44+08:00">2019-03-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/jessehao.github.io/categories/扯会儿单片机开发/" itemprop="url" rel="index"><span itemprop="name">扯会儿单片机开发</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>正在写作这篇文章的笔者是一名大四的软件工程学生，因为实习工作的需要，奉命研究单片机开发，所以我所扯的内容可能更适合跟我的情况比较相同的人。<br>如果你懂一些计算机原理和C语言开发，读下面的文章就不会很费劲。但如果不懂也没关系，那就交叉学习吧。</p>
<hr>
<h2 id="什么是单片机"><a href="#什么是单片机" class="headerlink" title="什么是单片机"></a>什么是单片机</h2><p>从CPU说起。</p>
<h4 id="CPU-Central-Processing-Unit-中央处理器"><a href="#CPU-Central-Processing-Unit-中央处理器" class="headerlink" title="CPU(Central Processing Unit, 中央处理器)"></a>CPU(Central Processing Unit, 中央处理器)</h4><p>CPU由运算器、缓存器及总线构成。其中，运算器是指<a href="https://en.wikipedia.org/wiki/Arithmetic_logic_unit" target="_blank" rel="noopener">ALU(Arithmetic logic unit，算术逻辑单元)</a>，是CPU的核心；<a href="https://en.wikipedia.org/wiki/Cache" target="_blank" rel="noopener">缓存器（Cache）</a>可分为一级缓存、二级缓存和三级缓存，容量逐步递增，读写速度速度递减，成本递减；<a href="https://en.wikipedia.org/wiki/Bus_(computing" target="_blank" rel="noopener">总线（Bus）</a>)分为数据、控制和状态三种。典型代表：<a href="https://en.wikipedia.org/wiki/Intel_8086" target="_blank" rel="noopener">8086</a>。</p>
<ul>
<li><strong>物理结构</strong><br>从物理结构上看，CPU可分为逻辑部件、寄存器部件和控制部件。逻辑部件主要用于定点或浮点算术运算操作、移位操作和逻辑操作；寄存器部件可分为通用、专用和控制。每一种寄存器都有它自己的用处；控制部件主要用于指令译码和发出控制信号。</li>
<li><strong>性能参数</strong><br>作为数据处理的中心，最主要的参数可以说是主频和外频了。先说外频，外频是基准频率，它决定了主板的运行速度，人们所说的<a href="https://en.wikipedia.org/wiki/Overclocking" target="_blank" rel="noopener">超频</a>，超的就是外频。<br><strong>主频=外频*倍频</strong><br>主频，又叫时钟频率。由上述公式可以看出主频由外频决定。主频表示CPU内数字脉冲信号震荡的速度，它可以说明CPU的运算和处理数据的速度。简而言之，主频越高，CPU越快。CPU每做一个动作，处理数据或发布命令，都要随着主频的节奏来。所以这是个很有节奏感的东西。</li>
</ul>
<h4 id="计算机-Computer"><a href="#计算机-Computer" class="headerlink" title="计算机(Computer)"></a>计算机(Computer)</h4><p>依照<a href="https://en.wikipedia.org/wiki/Von_Neumann_architecture" target="_blank" rel="noopener">冯诺依曼体系</a>，计算机的五大组成部件为运算器、控制器、存储器、输入设备和输出设备。其中运算器和控制器合起来就是CPU；存储器又可以拆分为内存和外存；输入和输出设备就是键盘、鼠标、显示器等。</p>
<ul>
<li><strong>处理器</strong><br>运算器和控制器可以合称为处理器，CPU主要就是这两个部件。前者负责数据处理，后者发布命令。</li>
<li><strong>存储器</strong><br>存储器主要是指<a href="https://en.wikipedia.org/wiki/Random-access_memory" target="_blank" rel="noopener">内存（RAM，Random Access Memory，随机存取存储器）</a>,靠电容的充放电存储电容信号进而可在逻辑上表示数字信号。由于电容充放电速度很快，所以内存的读写速度仅次于CPU中的缓存。但又因为是电容，所以无法在不通电的情况下存储这些信息。这样就催生了<a href="https://en.wikipedia.org/wiki/Read-only_memory" target="_blank" rel="noopener">ROM</a>，为了保存数据但只能写入一次的只读存储器。再后来为了能擦了重写就出现了<a href="https://en.wikipedia.org/wiki/EPROM" target="_blank" rel="noopener">EPROM</a>和<a href="https://en.wikipedia.org/wiki/EEPROM" target="_blank" rel="noopener">EEPROM</a>等可擦写ROM。硬盘、U盘等都是前者的衍生物，他们都统称为外存（external storage），其主要作用就是在断电的时候能够保存数据。因为涉及到物理动作（掰硬盘里面的小磁针、在光盘上烫洞），所以相对于内存的速度要慢上要几个档次。</li>
<li><strong>I/O</strong><br>I/O就是与之交互的基础了，通过输入设备来告诉它，通过输出设备来告诉你。就是机器交互的耳朵和嘴了。</li>
</ul>
<h4 id="单片机（MCU-Microcontroller-Unit）"><a href="#单片机（MCU-Microcontroller-Unit）" class="headerlink" title="单片机（MCU, Microcontroller Unit）"></a>单片机（MCU, Microcontroller Unit）</h4><p>是一种<a href="https://en.wikipedia.org/wiki/Integrated_circuit" target="_blank" rel="noopener">集成电路(IC, Integrated Circuit)</a>，其实应该叫微控制器，单片机这个名字主要是指之前的SCM(Single Chip Micyoco, 嗯… Micyoco是个神奇的单词)。而现在MCU是由SCM发展而来的，在高级点就可以说是SoC(System on Chip)。但后面的我所提到的单片机就是说MCU啦（因为我主要玩了下51单片机，这个是什么鬼我后面会说）。</p>
<p>说正事儿，单片机可以说是<strong>“浓缩的计算机”</strong>而不是“浓缩的CPU”，首先维基百科对他的解释是：</p>
<blockquote>
<p>a small computer on a integrated circuit。</p>
</blockquote>
<p>其次是因为它内部不仅仅有运算器、控制器和寄存器这种CPU三件套，他还常封装有RAM、ROM这种存储器部件，还有I/O口供人们编程及操作。所以总结来说，他有处理器、存储器和I/O，也算是符合冯诺依曼体系的<strong>“浓缩计算机”</strong>。</p>
<ul>
<li><strong>应用领域</strong><br>说到这种“浓缩计算机”的应用，可以说是广到没朋友。智能仪表、实时工控、通讯设备、导航系统、家用电器等等。随着物联网(IoT)时代的到来，单片机可谓再一次大展神威，我们手中的控制端可能是手机这种高级玩意儿，但是用来控制设备电路的接收端就是单片机要做的事情了。让家用电器接入网络，就是在其内部放一块带Wifi模块的单片机即可。</li>
<li><strong>封装类型</strong><br>刚才说到它算一个计算机，他的那些部件都是怎么放在一起的？这就涉及到封装问题了。以下列出主要的单片机封装形式。</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">封装</th>
<th>全称</th>
<th>中文名称</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://en.wikipedia.org/wiki/Dual_in-line_package" target="_blank" rel="noopener">DIP</a></td>
<td>Dual In-Line Package</td>
<td>双列直插式封装</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://en.wikipedia.org/wiki/Chip_carrier#Plastic_leaded_chip_carrier" target="_blank" rel="noopener">PLCC</a></td>
<td>Plastic Leaded Chip Carrier</td>
<td>带引线的塑料芯片封装</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://en.wikipedia.org/wiki/Quad_Flat_Package" target="_blank" rel="noopener">QFP</a></td>
<td>Quad Flat Package</td>
<td>塑料方形扁平式封装</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://en.wikipedia.org/wiki/Pin_grid_array" target="_blank" rel="noopener">PGA</a></td>
<td>Pin Grid Array Package</td>
<td>插针网络阵列封装</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://en.wikipedia.org/wiki/Ball_grid_array" target="_blank" rel="noopener">BGA</a></td>
<td>Ball Grid Array Package</td>
<td>球栅阵列封装</td>
</tr>
</tbody>
</table>
<p>这里不做详细描述，具体资料可点击封装名称进入查阅。</p>
<hr>
<h2 id="51单片机"><a href="#51单片机" class="headerlink" title="51单片机"></a>51单片机</h2><p>你若是初学单片机，并且直接上网去查“单片机入门”之类的关键词，你绝对会看到“51单片机什么什么的”。谁知道51单片机是啥玩意，一开始我还以为51是个牌子，然后就开始吐槽满世界的广告啊，能不能安安静静的学个单片机啊。</p>
<h4 id="什么是51单片机"><a href="#什么是51单片机" class="headerlink" title="什么是51单片机"></a>什么是51单片机</h4><p>百度百科的摘要是这样说的：</p>
<blockquote>
<p><a href="http://baike.baidu.com/link?url=JEGfVJUvVzg_jwj6f6QCNQ4zMGGhDFp7PNzxOFdub8ybq88pF_tMULzRGv1LXm7mO5vyS7_TgC9s_kCZeVUznq" target="_blank" rel="noopener">51单片机</a>是对所有兼容Intel 8031<a href="http://baike.baidu.com/view/178189.htm" target="_blank" rel="noopener">指令系统</a>的单片机的统称。该系列单片机的始祖是Intel的8004单片机，后来随着Flash rom技术的发展，8004单片机取得了长足的进展，成为应用最广泛的8位单片机之一，其代表型号是<a href="http://baike.baidu.com/view/110906.htm" target="_blank" rel="noopener">ATMEL公司</a>的AT89系列，它广泛应用于工业测控系统之中。很多公司都有51系列的兼容机型推出，今后很长的一段时间内将占有大量市场。51单片机是基础入门的一个单片机，还是应用最广泛的一种。需要注意的是51系列的单片机一般不具备自编程能力。</p>
</blockquote>
<p>维基百科是这样说的：</p>
<blockquote>
<p><em>The page “<a href="https://en.wikipedia.org/w/index.php?title=51-MCU&amp;action=edit&amp;redlink=1" target="_blank" rel="noopener">51-MCU</a>“ does not exist. You can ask for it to be created, but consider checking the search results below to see whether the topic is already covered.</em></p>
</blockquote>
<p>嗯，看来这个词是国内出来的。根据百度百科上的内容我们可以了解到如下信息</p>
<table>
<thead>
<tr>
<th style="text-align:center">Key</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">指令集</td>
<td>8031</td>
</tr>
<tr>
<td style="text-align:center">始祖</td>
<td>Intel 8004 单片机</td>
</tr>
<tr>
<td style="text-align:center">处理器</td>
<td>8位</td>
</tr>
<tr>
<td style="text-align:center">I/O线</td>
<td>32条</td>
</tr>
</tbody>
</table>
<ul>
<li><p><strong>这跟“51”有个蛋的关系啊？！</strong><br>后来了解到，这款单片机的起点是Intel的MCS51系列单片机，此系列包括：8031，8051，8751，8032，8052，8752等，后来Intel普度众生，将技术传了下去。人们将后来的那些单片机都统称为51单片机。</p>
</li>
<li><p><strong>那为毛我入个门就给我个51单片机啊？！</strong><br>因为此款单片机应用非常广，而且支持<a href="https://en.wikipedia.org/wiki/In-system_programming" target="_blank" rel="noopener">在线编程(ISP, In-System Programmability)</a>，用它可以搭建比较为复杂的系统，相较于其他8位单片机（AVR、PIC）而言，他出现较早，可以获取大量学习资料。所以…</p>
</li>
</ul>
<h4 id="引脚"><a href="#引脚" class="headerlink" title="引脚"></a>引脚</h4><p>单片机的操作向来靠引脚，51系列也不除外。常见的是40脚DIP封装，以此为例说说以下几类引脚。</p>
<ul>
<li><strong>电源</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">引脚</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Vcc</td>
<td>电源，用于引入正电平</td>
</tr>
<tr>
<td style="text-align:center">GND</td>
<td>地线，引入负电平</td>
</tr>
</tbody>
</table>
<p>关于电平的资料请参考：<a href="https://en.wikipedia.org/wiki/Logic_level" target="_blank" rel="noopener">逻辑电平</a></p>
<ul>
<li><strong>时钟</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">引脚</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">XTAL2</td>
<td>片内震荡电路输出端</td>
</tr>
<tr>
<td style="text-align:center">XTAL1</td>
<td>片内震荡电路输入端</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>编程控制</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">引脚</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">RST</td>
<td>用于复位</td>
</tr>
<tr>
<td style="text-align:center">PSEN</td>
<td>当有扩展ROM时用，在读外部ROM时，低电平有效</td>
</tr>
<tr>
<td style="text-align:center">ALE/PROG</td>
<td>当有扩展RAM时用</td>
</tr>
<tr>
<td style="text-align:center">EA/Vpp</td>
<td>当有扩展ROM时用，高电平读取内部ROM，低电平读取外部ROM</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>I/O</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">引脚</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">P0</td>
<td>双向，8位，三态</td>
</tr>
<tr>
<td style="text-align:center">P1</td>
<td>准双向，8位</td>
</tr>
<tr>
<td style="text-align:center">P2</td>
<td>准双向，8位</td>
</tr>
<tr>
<td style="text-align:center">P3</td>
<td>准双向，8位，拥有第二功能</td>
</tr>
</tbody>
</table>
<p>P3第二功能定义：</p>
<table>
<thead>
<tr>
<th style="text-align:center">标号</th>
<th style="text-align:center">第二功能</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">P3.0</td>
<td style="text-align:center">RXD</td>
<td>串行输入口</td>
</tr>
<tr>
<td style="text-align:center">P3.1</td>
<td style="text-align:center">TXD</td>
<td>串行输出口</td>
</tr>
<tr>
<td style="text-align:center">P3.2</td>
<td style="text-align:center">INT0</td>
<td>外部中断0</td>
</tr>
<tr>
<td style="text-align:center">P3.3</td>
<td style="text-align:center">INT1</td>
<td>外部中断1</td>
</tr>
<tr>
<td style="text-align:center">P3.4</td>
<td style="text-align:center">T0</td>
<td>定时器/计数器0外部输入端</td>
</tr>
<tr>
<td style="text-align:center">P3.5</td>
<td style="text-align:center">T1</td>
<td>定时器/计数器1外部输入端</td>
</tr>
<tr>
<td style="text-align:center">P3.6</td>
<td style="text-align:center">WR</td>
<td>外部数据存储器写脉冲</td>
</tr>
<tr>
<td style="text-align:center">P3.7</td>
<td style="text-align:center">RD</td>
<td>外部数据存储器读脉冲</td>
</tr>
</tbody>
</table>
<h4 id="扩展的关键字"><a href="#扩展的关键字" class="headerlink" title="扩展的关键字"></a>扩展的关键字</h4><p>单片机编程支持汇编和C，其他的我没用过也不太清楚。如果入门的话最好的选择就是C啦，首先你很有可能学过C，就算没学过也很好上手，去买本谭浩强的<a href="http://product.dangdang.com/22814833.html" target="_blank" rel="noopener">《C程序设计》</a>吧。</p>
<p>除了标准的<a href="https://en.wikipedia.org/wiki/ANSI_C" target="_blank" rel="noopener">ANSI C</a>关键字外，单片机编程还扩展了如下几个类型的关键字：</p>
<ul>
<li><strong>位标量说明</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">关键字</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">bit</td>
<td>声明一个位标量或位类型函数</td>
</tr>
<tr>
<td style="text-align:center">sbit</td>
<td>声明一个可位寻址变量，必须定义为外部变量</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>特殊功能寄存器声明</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">关键字</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">sfr</td>
<td>声明一个特殊功能寄存器，必须定义为外部变量</td>
</tr>
<tr>
<td style="text-align:center">sfr16</td>
<td>声明一个16位的特殊功能寄存器，必须定义为外部变量</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>存储器类型说明</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">关键字</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">data</td>
<td>直接寻址的内部数据存储器</td>
</tr>
<tr>
<td style="text-align:center">bdata</td>
<td>可位寻址的内部数据存储器</td>
</tr>
<tr>
<td style="text-align:center">idata</td>
<td>间接寻址的内部数据存储器</td>
</tr>
<tr>
<td style="text-align:center">pdata</td>
<td>分页寻址的外部数据存储器</td>
</tr>
<tr>
<td style="text-align:center">xdata</td>
<td>外部数据存储器</td>
</tr>
<tr>
<td style="text-align:center">code</td>
<td>程序存储器</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>其他</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">关键字</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">interrupt</td>
<td>定义一个中断函数</td>
</tr>
<tr>
<td style="text-align:center">reentrant</td>
<td>定义一个再入函数</td>
</tr>
<tr>
<td style="text-align:center">using</td>
<td>定义芯片的工作寄存器</td>
</tr>
</tbody>
</table>
<h4 id="STC89C52"><a href="#STC89C52" class="headerlink" title="STC89C52"></a>STC89C52</h4><p>我的第一个实体单片机开发，就是这款了，STC89C52，可以说是增强型8051单片机。来，先看一下它的配置：</p>
<ul>
<li><strong>处理器</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">Key</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">核心</td>
<td>MCS-51</td>
</tr>
<tr>
<td style="text-align:center">最高运作频率</td>
<td>35MHz</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>物理参数</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">关键字</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">I/O</td>
<td>39</td>
</tr>
<tr>
<td style="text-align:center">工作温度</td>
<td>商业级：0°C~75°C；工业级：-40°C~85°C</td>
</tr>
<tr>
<td style="text-align:center">封装</td>
<td>DIP</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>存储器</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">关键字</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">RAM</td>
<td>512B</td>
</tr>
<tr>
<td style="text-align:center">ROM</td>
<td>8KB</td>
</tr>
<tr>
<td style="text-align:center">EEPROM</td>
<td>4KB</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>功能</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">关键字</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">定时器</td>
<td>3个</td>
</tr>
<tr>
<td style="text-align:center">串口</td>
<td>1个，全双工</td>
</tr>
<tr>
<td style="text-align:center">外部中断</td>
<td>4个</td>
</tr>
<tr>
<td style="text-align:center">看门狗</td>
<td>支持</td>
</tr>
<tr>
<td style="text-align:center">内置复位</td>
<td>支持</td>
</tr>
<tr>
<td style="text-align:center">ISP/IAP</td>
<td>支持</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>可选模式</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">关键字</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">掉电模式</td>
<td>支持</td>
</tr>
<tr>
<td style="text-align:center">空闲模式</td>
<td>支持</td>
</tr>
</tbody>
</table>
<p>我的这款的具体型号为：STC89C52_35I_PDIP40_1550HHT352.C90C<br>关于标识命名规则请参阅：<a href="http://blog.sina.com.cn/s/blog_60720ce601014jft.html" target="_blank" rel="noopener">STC全系列芯片命名规则说明</a></p>
<hr>
<h2 id="软件准备"><a href="#软件准备" class="headerlink" title="软件准备"></a>软件准备</h2><p>既然要编程，我们就需要开发环境，你可以选择Keil，也可以选择加载Keil插件的Eclipse。<br>代码写好后，通过编译器编译成单片机可以识别的<a href="https://en.wikipedia.org/wiki/Machine_code" target="_blank" rel="noopener">机器码</a>。机器码通常会保存为.hex文件，这个文件可以用那些十六进制文件查看器查看。这个文件的数据要写入到单片机的程序存储器中，通常为一个ROM。通常买的开发板都会集成串口及其芯片，还有配套的下载软件。你只需要安装好它的串口芯片的驱动程序，然后用下载器直接下载就好。如果是自己焊的板子就会麻烦一些了。这里不做说明，因为笔者还没干过。<br>还有一种就是通过Proteus模拟，在没有实体板的情况下可以考虑这种方式。Proteus可以模拟单片机的逻辑线路和演示效果。向里面的逻辑单片机下载程序的话，更是十分方便，在Proteus内可以很方便的操作完成。若是要模拟单片机与PC通信，那你就需要一个模拟串口连接的程序了—VSPD(Virtual Serial Port Driver)。</p>
<ul>
<li><strong>列个清单</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">程序</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Keil</td>
<td>单片机开发的IDE，支持编译c、asm、c++。</td>
</tr>
<tr>
<td style="text-align:center">单片机串口驱动</td>
<td>用于让计算机识别单片机</td>
</tr>
<tr>
<td style="text-align:center">Proteus</td>
<td>模拟集成电路，可以演示效果</td>
</tr>
<tr>
<td style="text-align:center">VSPD</td>
<td>模拟串口连接</td>
</tr>
<tr>
<td style="text-align:center">程序下载程序</td>
<td>用于将编译好hex文件下载到单片机</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="一个软工狗的总结"><a href="#一个软工狗的总结" class="headerlink" title="一个软工狗的总结"></a>一个软工狗的总结</h2><p>作为一个软工狗，我对我们专业的理解是更专注于一个软件的工程项目的始终而不是技术实现，偏向于“工”。而单片机开发是更加贴近计算机底层的一种开发，更偏向于“理”，而且也不会采用面向对象的思想。所以，比起之前所做的网页开发也好，客户端开发也罢，都显得更加不友好。</p>
<ul>
<li><strong>内存可能不够用</strong><br>在开发过程中会开始考虑内存够不够用这种问题，这个是现代IT学子几乎不会考虑的问题，不说电脑，手机的内存都大的一腿，但是来到单片机的地盘，你就得考虑了，考虑好不要动不动就上个double（我目前用的最长的变量类型也就是unsigned int），而且为了拓展范围长度还要考虑是不是要把变量声明称无符号类型，更严重的情况可能还要掰指头数清楚你的变量有没有声明的太多。</li>
<li><strong>一切从优</strong><br>也是因为硬件资源的限制，所以在做一些实现的时候你不能只考虑如何实现，还要考虑单片机吃不吃得起你的代码。所以在这个领域，面向对象这种思想是基本弃用的（面向对象的思想向来是对程序员友好，对机器不太友好的）。考虑好你程序的时间及空间复杂度，因为单片机不仅内存小，主频一般也特别低。</li>
<li><strong>二进制是爸爸</strong><br>好好的巩固一下之前所学的C语言吧，还有二进制操作才是爸爸级别的操作。说到这一点其实还是因为硬件资源的限制。各种且或非、异或、移位会让代码变得高效，虽然我们之前并不习惯这样做。其实很多牛逼的程序员都会很擅长使用二进制操作，因为这样很对机器的口味（1024吧，凑个整）。</li>
<li><strong>很好玩！</strong><br>不像客户端或web开发，我们只是在调用，很少有思维上的突破。我觉得单片机开发会更灵活，你可以去网上花十块钱不到买各种小部件添加上去调用着玩。自己设计小型自动电路是我觉得再有趣不过的事情了。</li>
<li><strong>怎么个开始</strong><br>要是没学过C语言，先去把C学了。若是学好了，那就了解基础知识后直接实战。关于实战，我的建议是，先在Proteus上模拟，等稍微熟练再往实体开发板里写。一个是因为Proteus模拟，能简单实践一下画板子，可以学习简单的线路，但又不像真正画板子那样麻烦。另一个是因为单片机的程序存储器的擦写次数是有限的，虽然这个次数也不用特别在意，但是能少一次就少一次嘛。到了实体开发板阶段，就不是为了验证你的程序逻辑了，而是解决实际问题，因为Proteus并不会完美模拟出实际情况，这也是由模拟到实践的真正过度。最后，可以自己买各种工具（洞洞板、锡丝、松香、烙铁、吸锡器、烙铁架）来焊个板子，在自己焊的板子上编程。这样就完成了从焊到编再到实现的一条龙DIY。</li>
</ul>
<p>我很推荐软工狗们尝试单片机开发，因为这可以让你对计算机原理和底层有更深的认识，还可以体会到设计并实现各种DIY小器件的乐趣。望各位就着汗水尽情释放创造力吧！</p>
<p>玩的开心~</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Jesse Hao</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/jessehao.github.io/archives/">
                
                    <span class="site-state-item-count">10</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/jessehao.github.io/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/jessehao.github.io/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/jessehao" title="GitHub &rarr; https://github.com/jessehao"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:jeasygates@hotmail.com" title="E-Mail &rarr; mailto:jeasygates@hotmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jesse Hao</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.0.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/jessehao.github.io/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/jessehao.github.io/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/jessehao.github.io/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/jessehao.github.io/js/src/utils.js?v=7.0.0"></script>

  <script src="/jessehao.github.io/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/jessehao.github.io/js/src/schemes/muse.js?v=7.0.0"></script>



  

  


  <script src="/jessehao.github.io/js/src/bootstrap.js?v=7.0.0"></script>


  
  



  




  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
